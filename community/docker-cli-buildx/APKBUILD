# Contributor: Jake Buchholz Göktürk <tomalok@gmail.com>
# Maintainer: Jake Buchholz Göktürk <tomalok@gmail.com>
pkgname=docker-cli-buildx
_commit=c513d34049e499c53468deac6c4267ee72948f02
_moby_ver=23.0.4
pkgver=0.10.4
pkgrel=10
pkgdesc="A Docker CLI plugin for extended build capabilities"
url="https://docs.docker.com/engine/reference/commandline/buildx_build"
arch="all"
license="Apache-2.0"
makedepends="go"
options="net"
source="
	buildx-$pkgver.tar.gz::https://github.com/docker/buildx/archive/v$pkgver.tar.gz
	moby-$_moby_ver.tar.gz::https://github.com/moby/moby/archive/v$_moby_ver.tar.gz
	client-define-a-dummy-hostname-to-use-for-local-connections.patch.moby
"

_buildx_installdir="/usr/libexec/docker/cli-plugins"

builddir="$srcdir"/buildx-"$pkgver"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

prepare() {
       default_prepare

       for f in $source; do
               case $f in
                       *.patch.moby) patch -d "$srcdir"/moby-$_moby_ver -p1 <"$srcdir/$f";;
               esac
       done

       # go.mod required for any replacement to work
       (
               cd "$srcdir/moby-$_moby_ver"
               go mod init github.com/docker/docker
       )

       (
               cd "$builddir"
               go work init .
               go work use "$srcdir/moby-$_moby_ver"
       )
}

build() {
	PKG=github.com/docker/buildx
	local ldflags="-X $PKG/version.Version=v$pkgver -X $PKG/version.Revision=$_commit -X $PKG/version.Package=$PKG"
	go build -modcacherw -ldflags "$ldflags" -o docker-buildx ./cmd/buildx
}

check() {
	# bake and gitutil tests do not succeed inside abuild environment
	local pkgs="$(go list -modcacherw ./... | grep -Ev '(bake|gitutil)')"
	go test -modcacherw -short $pkgs
	./docker-buildx version
}

package() {
	# this is circular to have top-level, so depend on it in package itself
	depends="docker-cli"
	install -Dm755 docker-buildx "$pkgdir$_buildx_installdir"/docker-buildx
}

sha512sums="
f82b89b8dd4e45524c8d353c4d7588f47b1c7b7ecf759fd9605247c1c7aa0ca152c3ecdec0e0b62b5eef05e6b65d2ca1f5ccab6d75819b92fc92ff62b44105b7  buildx-0.10.4.tar.gz
94d2c748541cf402197e98f93f574daf72bd84fc7603bf30e23674be36862ddbff5f37ad667455a710d730b9c5bc11962c287d6fd60a20320e0e0a41e3329c44  moby-23.0.4.tar.gz
3bbdc4de5215381cc0bdbcf2ee1c7aa85aff6aefae3fefb536a80e693a6292c1d2a03699b56842492e06435f3318f61469f8803e0ff2d42640786be4fe71e663  client-define-a-dummy-hostname-to-use-for-local-connections.patch.moby
"
