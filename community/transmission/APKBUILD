# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer: psykose <alice@ayaya.dev>
pkgname=transmission
pkgver=4.0.1
pkgrel=1
pkgdesc="Lightweight GTK BitTorrent client"
url="https://transmissionbt.com/"
install="transmission-daemon.pre-install transmission-daemon.post-upgrade"
arch="all"
license="GPL-2.0-or-later AND MIT"
pkgusers="transmission"
pkggroups="transmission"
makedepends="
	cmake
	curl-dev
	dbus-glib-dev
	gtkmm3-dev
	intltool
	libdeflate-dev
	libevent-dev
	miniupnpc-dev
	openssl-dev
	qt6-qtsvg-dev
	qt6-qttools-dev
	samurai
	"
source="https://github.com/transmission/transmission/releases/download/$pkgver/transmission-$pkgver.tar.xz
	transmission-daemon.initd
	transmission-daemon.confd
	transmission-daemon.logrotate
	"
subpackages="
	$pkgname-dev
	$pkgname-lang-gtk:gtklang
	$pkgname-gtk
	$pkgname-lang-qt:qtlang
	$pkgname-qt
	$pkgname-base
	$pkgname-cli
	$pkgname-daemon
	$pkgname-daemon-openrc
	$pkgname-doc
	"

case "$CARCH" in
riscv64)
	options="$options textrels"
	;;
esac

# secfixes:
#   3.00-r0:
#     - CVE-2018-10756

build() {
	CXXFLAGS="$CXXFLAGS -O2 -DNDEBUG" \
	CFLAGS="$CFLAGS -O2 -DNDEBUG" \
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=None \
		-DENABLE_CLI=ON \
		-DENABLE_GTK=ON \
		-DENABLE_NLS=ON \
		-DENABLE_QT=ON \
		-DENABLE_TESTS="$(want_check && echo ON || echo OFF)" \
		-DINSTALL_LIB=ON \
		-DRUN_CLANG_TIDY=OFF \
		-DUSE_SYSTEM_DEFLATE=ON \
		-DWITH_CRYPTO="openssl" \
		-DWITH_SYSTEMD=OFF \
		-DUSE_QT_VERSION=6
	cmake --build build
}

check() {
	# unstable
	ctest --test-dir build --output-on-failure -j4 -E LT.DhtTest.usesBootstrapFile
}

package() {
	# the base package used to be -gtk, so depend on it now.
	depends="$pkgname-gtk=$pkgver-r$pkgrel"
	DESTDIR="$pkgdir" cmake --install build

	install -D -m755 "$srcdir"/transmission-daemon.initd \
		"$pkgdir"/etc/init.d/transmission-daemon
	install -D -m644 "$srcdir"/transmission-daemon.confd \
		"$pkgdir"/etc/conf.d/transmission-daemon
}

daemon() {
	pkgdesc="Lightweight BitTorrent client (daemon and webinterface)"

	install -d -o transmission -g transmission \
		"$subpkgdir"/var/lib/transmission \
		"$subpkgdir"/var/log/transmission
	amove usr/bin/transmission-daemon \
		usr/share/transmission
	install -D -m644 "$srcdir"/transmission-daemon.logrotate \
		"$subpkgdir"/etc/logrotate.d/transmission-daemon
}

cli() {
	pkgdesc="Lightweight BitTorrent client (cli and remote)"

	amove usr/bin/transmission-cli \
		usr/bin/transmission-create \
		usr/bin/transmission-edit \
		usr/bin/transmission-show \
		usr/bin/transmission-remote
}

base() {
	pkgdesc="Base icons/data for $pkgname"

	amove usr/share/icons
	amove usr/share/metainfo
}

gtk() {
	pkgdesc="Lightweight BitTorrent client (GTK4 client)"
	depends="$pkgname-base=$pkgver-r$pkgrel"

	amove usr/bin/transmission-gtk
	amove usr/share/applications/transmission-gtk.desktop
}

gtklang() {
	pkgdesc="Translations for Transmission GTK"
	install_if="$pkgname-gtk=$pkgver-r$pkgrel lang"

	amove usr/share/locale
}

qt() {
	pkgdesc="Lightweight BitTorrent client (Qt6 client)"
	depends="$pkgname-base=$pkgver-r$pkgrel qt6-qtsvg"

	amove usr/bin/transmission-qt
	amove usr/share/applications/transmission-qt.desktop
}

qtlang() {
	pkgdesc="Translations for Transmission Qt"
	install_if="$pkgname-qt=$pkgver-r$pkgrel lang"

	amove usr/share/transmission/translations
}

sha512sums="
a0226c96b08fd7be7cb9763132e36e59a4f84d67277c345860ac5a2e685ec0d5f2e8b3fe1e2d090e1180499518084de99387b822bb6dbdc1b7cb076d9a99ce05  transmission-4.0.1.tar.xz
d31275fba7eb322510f9667e66a186d626889a6e3143be2923aae87b9c35c5cf0c508639f1cb8c1b88b1e465bc082d80bb1101385ebde736a34d4eeeae0f6e15  transmission-daemon.initd
dbc093fe00335bb207c28a4e810becc15e74b6f75e7579d561b160755d6b54bb23a45db39ee3480195a94a5e9bffdad692559d1b9662bba28119d18b713747a1  transmission-daemon.confd
a0e770a46b916cde7ea13076a0e4646c43f3b4db4bc85c18d2fee7cdb5cab458a74897ffb4bf66327f35ce145e89f5320460034a1392cc0df66aa1a3c0d82f7b  transmission-daemon.logrotate
"
