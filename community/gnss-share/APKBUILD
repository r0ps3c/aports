# Contributor: Clayton Craft <clayton@craftyguy.net>
# Maintainer: Clayton Craft <clayton@craftyguy.net>
pkgname=gnss-share
pkgver=0.5
pkgrel=2
pkgdesc="GNSS location provider, supporting multiple concurrent clients"
url="https://gitlab.com/postmarketOS/gnss-share"
arch="all"
license="GPL-3.0-or-later"
makedepends="go"
subpackages="
	$pkgname-geoclue::noarch
	$pkgname-openrc
	$pkgname-tools
	"
source="
	https://gitlab.com/postmarketOS/gnss-share/-/archive/$pkgver/gnss-share-$pkgver.tar.gz
	geoclue.conf
	"

export CGO_ENABLED=0
export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

build() {
	go build -v -o gnss-share ./cmd/gnss-share
	go build -v -o stmctl ./cmd/stmctl
}

check() {
	go test ./...
}

package() {
	install -Dm755 "gnss-share" \
		"$pkgdir/usr/bin/gnss-share"
	install -Dm755 "stmctl" \
		"$pkgdir/usr/bin/stmctl"

	install -Dm644 "gnss-share.conf" \
		"$pkgdir/etc/gnss-share.conf"

	install -Dm755 "openrc/gnss-share.initd" \
		"$pkgdir/etc/init.d/gnss-share"
	install -Dm755 "openrc/gnss-share.confd" \
		"$pkgdir/etc/conf.d/gnss-share"
	install -Dm644 "$srcdir"/geoclue.conf \
		"$pkgdir"/etc/geoclue/conf.d/gnss-share.conf
}

tools() {
	amove usr/bin/stmctl
}

geoclue() {
	install_if="$pkgname=$pkgver-r$pkgrel geoclue"

	amove etc/geoclue/conf.d/gnss-share.conf
}

sha512sums="
142de3c92ab3e67d1d16140ccf13fc5d49fff97fa944914a4d5d0cecfeab545aec83aeecdd9607991eb245796f219849e88afd63072dfc0d9f929f83a0a63c9d  gnss-share-0.5.tar.gz
f1d1c391d7104dd079ee6c7c08b99f6a84749b59eb66f3ceb1994d36198840e81f011b573af455eff1231ddbaf0c786c77785f799355d6d82005317633bca1ed  geoclue.conf
"
