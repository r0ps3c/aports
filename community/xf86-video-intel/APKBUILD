# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=xf86-video-intel
pkgver=2.99.917_git20210115
_gitrev=31486f40f8e8f8923ca0799aea84b58799754564
pkgrel=3
pkgdesc="X.Org driver for Intel cards"
url="https://xorg.freedesktop.org"
arch="x86 x86_64"
license="MIT"
depends="mesa-dri-gallium"
makedepends="
	eudev-dev
	libdrm-dev
	libxi-dev
	libxcursor-dev
	libxrandr-dev
	libxrender-dev
	libxscrnsaver-dev
	libxinerama-dev
	libxtst-dev
	libxv-dev
	libxvmc-dev
	mesa-dev
	meson
	util-macros
	xcb-util-dev
	xorg-server-dev
	xorgproto
	"
subpackages="$pkgname-doc"
source="https://gitlab.freedesktop.org/xorg/driver/xf86-video-intel/-/archive/$_gitrev/xf86-video-intel-$_gitrev.tar.gz"
builddir="$srcdir/xf86-video-intel-$_gitrev"

build() {
	export LDFLAGS="$LDFLAGS -Wl,-z,lazy -lXv"
	abuild-meson \
		-Ddefault-dri=3 \
		-Dvalgrind=false \
		.  output
	meson compile -C output
}

check() {
	meson test --no-rebuild --print-errorlogs -C output
}

package() {
	DESTDIR="$pkgdir" meson install --no-rebuild -C output
	install -Dm644 COPYING "$pkgdir"/usr/share/licenses/$pkgname/COPYING

	# http://bugs.alpinelinux.org/issues/3312
	chmod o-x "$pkgdir"/usr/libexec/xf86-video-intel-backlight-helper
}

sha512sums="
a2323f20c6de89c2579d8af7bb66c58dab974ce560e4bc2fa91f4e3bb6ec7766153edbf9f9ddb92f9d572995d191702444fac1dceaf819b403158573d79246c6  xf86-video-intel-31486f40f8e8f8923ca0799aea84b58799754564.tar.gz
"
