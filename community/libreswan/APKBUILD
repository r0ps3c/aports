# Contributor: Will Sinatra <wpsinatra@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libreswan
pkgver=4.9
pkgrel=1
pkgdesc="IPsec implementation for Linux"
url="https://libreswan.org/"
arch="all"
license="GPL-2.0-or-later"
depends="dnssec-root nss-tools iproute2 !strongswan"
provides="openswan=$pkgver-r$pkgrel"
options="!check" # no testsuite
makedepends="
	bash
	bison
	bsd-compat-headers
	coreutils
	curl-dev
	flex
	gmp-dev
	ldns-dev
	libcap-ng-dev
	linux-pam-dev
	nspr-dev
	nss-dev
	unbound-dev
	xmlto
	"
subpackages="$pkgname-doc $pkgname-openrc"
source="https://download.libreswan.org/libreswan-$pkgver.tar.gz
	CVE-2023-23009-libreswan-4.2-4.9.patch
	CVE-2023-30570.patch
	initd-runscript.patch
	Makefile.inc.local
	"

# secfixes:
#   4.9-r2:
#     - CVE-2023-30570
#   4.9-r1:
#     - CVE-2023-23009
#   4.6-r0:
#     - CVE-2022-23094
#   3.32-r0:
#     - CVE-2020-1763
#   3.29-r0:
#     - CVE-2019-10155
#   3.28-r0:
#     - CVE-2019-12312

build() {
	cp "$srcdir"/Makefile.inc.local "$builddir"
	make WERROR_CFLAGS="" \
		INITDIR_DEFAULT=/etc/init.d \
		PREFIX=/usr \
		FINALBINDIR=/usr/libexec/ipsec \
		FINALLIBEXECDIR=/usr/libexec/ipsec \
		programs
}

package() {
	make FINALMANDIR=share/man \
		INITDIR_DEFAULT=/etc/init.d \
		PREFIX=/usr \
		DESTDIR="$pkgdir" \
		INSTCONFFLAGS=-m644 \
		FINALBINDIR=/usr/libexec/ipsec \
		FINALLIBEXECDIR=/usr/libexec/ipsec \
		install
}

sha512sums="
4a43b09b0ef1bacc64ca1b74e7c268df7f024d8b6a9633a489f373ecd9327b173e9508dbc13c4d25ee74f3e2ba569d9d38dfd851fd98cf3cde4a61ef90a1d9d5  libreswan-4.9.tar.gz
98bf86c5e45de1de0ada47b391039a5bba89f31febf2747009edb3db7ba141952e12dc475b4794d6e5e4f23231aeb86a1651aecca4ce7ebc24162246f9a6329b  CVE-2023-23009-libreswan-4.2-4.9.patch
db15cc41a131f3609ad16fba6d31441b0d72a6541cb328c76d5fa44edf44864cbfc50f2e8659f0fd5ea243b824bcfeabd66f77f87f92d3744496ee051f98ad0b  CVE-2023-30570.patch
50bba031d0342695727f520840d3e3650bd9ffae918374f03b122573152d08399128e9fb04e6a52321801f3d5dc7c9eab96364ae581f3e673c947dc283e45c04  initd-runscript.patch
94bcde573fc320450864394f3824bfe23e6ac8528a7b0b8a7d97d02a3883b6f47951f8a89a2c46cc394c65c5b3f9788b644f7f911f90ac78540e6479715e0a11  Makefile.inc.local
"
