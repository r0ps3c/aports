# Contributor: Celeste <cielesti@protonmail.com>
# Contributor: qaqland <qaq@qaq.land>
# Maintainer: Celeste <cielesti@protonmail.com>
pkgname=ktistec
pkgver=2.1.0
pkgrel=0
pkgdesc="Single-user ActivityPub server written in Crystal"
url="https://github.com/toddsundsted/ktistec"
arch="x86_64 aarch64" # crystal
license="AGPL-3.0-or-later"
depends="tzdata"
makedepends="
	crystal
	libxml2-dev
	musl-utils
	openssl-dev
	shards
	sqlite-dev
	"
checkdepends="yaml-dev"
options="net"
install="$pkgname.pre-install"
pkgusers="ktistec"
pkggroups="ktistec"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/toddsundsted/ktistec/archive/refs/tags/v$pkgver.tar.gz
	ktistec.initd
	ktistec.confd

	update-shard-lock.patch
	"
options="!check" # TODO: spectator macro incompatibilities with Crystal 1.13.1

export CRYSTAL_CACHE_DIR="${CRYSTAL_CACHE_DIR:-"$srcdir/.cache"}"
export SHARDS_CACHE_PATH="${SHARDS_CACHE_PATH:-"$srcdir/.cache"}"

prepare() {
	default_prepare

	shards install --frozen
}

build() {
	crystal build --no-debug --release src/ktistec/server.cr
}

check() {
	crystal spec -v
}

package() {
	install -Dvm755 server "$pkgdir"/usr/bin/ktistec
	install -dvm750 -o ktistec -g ktistec "$pkgdir"/var/lib/ktistec

	cp -a etc public "$pkgdir"/var/lib/ktistec/
	ln -sv public/uploads "$pkgdir"/var/lib/ktistec/
	chown -R ktistec:ktistec "$pkgdir"/var/lib/ktistec/public/uploads

	install -Dm755 "$srcdir"/ktistec.initd "$pkgdir"/etc/init.d/ktistec
	install -Dm644 "$srcdir"/ktistec.confd "$pkgdir"/etc/conf.d/ktistec
}

sha512sums="
56922f2b0b83ad57ed72d68b81609b11f6a3de8ba52b7243a371a0e5d5cedc65cb6e474be44db2374632a20740939a92750a2d2cf43a702cd6756362b5c50e42  ktistec-2.1.0.tar.gz
f2520a9306daf544fec456e739abf1bb1e1a188992bbd8ef4a3ce3915a342209521ceedef8fc871c659d12ca57914825a8dcebc04e0114147fe32fc7de1dcabb  ktistec.initd
b8971fe3a504df6173015a33a8edd64d74144128a1247328067fe82bee796d5faa55fa00de01690fedd7a027fb55e584b98b20277faa4140b913f52e4ec094e3  ktistec.confd
d4805a90c41e53a9a762fab39145cadedc29c8f8f55e9a6723b77c12ec63d1f3704f19e9f65b0a4742ecd9bd238157af33e02d31bcfe8ecb4220ced2471da8ea  update-shard-lock.patch
"
