# Contributor: Jean-Louis Fuchs <jean-louis.fuchs@adfinis-sygroup.ch>
# Maintainer: Jean-Louis Fuchs <jean-louis.fuchs@adfinis-sygroup.ch>
pkgname=pandoc-cli
pkgver=0.1.1
_actual=3.1.2
pkgrel=1
pkgdesc="universal markup converter"
url="https://pandoc.org/"
# limited by ghc
arch="aarch64 x86_64"
license="GPL-2.0-or-later"
makedepends="ghc cabal zlib-dev libffi-dev"
source="$pkgname-$pkgver.tar.gz::https://github.com/jgm/pandoc/archive/refs/tags/$_actual.tar.gz
	cabal.config
	"
builddir="$srcdir/pandoc-$_actual/pandoc-cli"
# todo
options="net !check"

# but everyone probably used this for cli, so provide the name,
# even though renamed
provides="pandoc=$pkgver-r$pkgrel"
replaces="pandoc"

# Cabal seems to be built without sandbox, moving the cabal-dir into src
export CABAL_DIR="$srcdir/.cabal"

cabal_update() {
	msg "Freezing $pkgname dependencies"

	# Resolve deps and generate fresh cabal.config with version constraints.
	cabal update
	(
		cd "$builddir"
		cabal v1-freeze --shadow-installed-packages

		# Add version tag at the first line.
		sed -i "1i--$pkgver" "cabal.config"

		mv "cabal.config" "$startdir/"
	)

	if ! abuild checksum; then
		die "Failed to update checksum, run 'abuild checksum' manually"
	fi
}

prepare() {
	default_prepare

	if [ "$(head -n 1 "$srcdir/cabal.config")" != "--$pkgver" ]; then
		die "Requirements file is outdated, run 'abuild cabal_update'"
	fi

	ln -sf "$srcdir/cabal.config" "$builddir/cabal.project.freeze"
}

build() {
	export PATH="$PATH:/usr/lib/llvm14/bin"
	cabal update
	cabal configure \
		--prefix='/usr' \
		--enable-split-sections \
		--ghc-option="-split-sections" \
		-fembed_data_files \
		-fstatic
	cabal build --jobs=${JOBS:-1}
}

package() {
	install -Dm755 ../dist-newstyle/build/*-linux/ghc-*/*/x/pandoc/build/pandoc/pandoc \
		-t "$pkgdir"/usr/bin/
	ln -sfv pandoc "$pkgdir"/usr/bin/pandoc-server
}

sha512sums="
69583e3798523ceeda1ecb555a2ac7650ae3c465edd8646c7bfa8b4ebe2dd9408693bdd76d0013d56ff8cc22cda03c97870f8a5c24c9c784d8ca14466e865b3c  pandoc-cli-0.1.1.tar.gz
d43dc11d20f2982f4f77f6fc1e51f8589087d2e35d3dd2cf9dc1d85453393ce306f54819790294878ea279e8afdafd89f9a5e330581dafd4b0c06b0b01c66478  cabal.config
"
