# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=eza
pkgver=0.14.1
pkgrel=0
pkgdesc="ls replacement written in Rust"
url="https://github.com/eza-community/eza"
arch="all"
license="MIT"
makedepends="
	cargo
	cargo-auditable
	libgit2-dev
	zlib-dev
	"
# For backward compatibility (Alpine <3.19), exa has been renamed to eza.
provides="exa=$pkgver-r$pkgrel"
subpackages="
	$pkgname-bash-completion
	$pkgname-fish-completion
	$pkgname-zsh-completion
	"
source="https://github.com/eza-community/eza/archive/v$pkgver/eza-$pkgver.tar.gz
	completions-exa.patch
	"
options="net"

# man pages are generated by pandoc which is available only on x86_64 and aarch64.
case "$CARCH" in x86_64 | aarch64)
	makedepends="$makedepends just pandoc-cli"
	subpackages="$subpackages $pkgname-doc"
esac

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --frozen --release

	if command -v pandoc >/dev/null; then
		just man
	fi
}

check() {
	cargo test --frozen
}

package() {
	install -Dm755 target/release/eza -t "$pkgdir"/usr/bin/

	install -Dm644 completions/bash/* -t "$pkgdir"/usr/share/bash-completion/completions/
	install -Dm644 completions/fish/* -t "$pkgdir"/usr/share/fish/vendor_completions.d/
	install -Dm644 completions/zsh/* -t "$pkgdir"/usr/share/zsh/site-functions/

	if command -v pandoc >/dev/null; then
		install -Dm644 target/man/eza.1 -t "$pkgdir"/usr/share/man/man1/
		install -Dm644 target/man/eza_colors.5 -t "$pkgdir"/usr/share/man/man5/
		install -Dm644 target/man/eza_colors-explanation.5 -t "$pkgdir"/usr/share/man/man5/
	fi

	# Symlinks for backward compatibility (exa has been renamed to eza).
	ln -s eza "$pkgdir"/usr/bin/exa
}

sha512sums="
1c94271476e98d8f2ef214a50352bc429e09db5647ffdf381572d1b9f9c593997d4e680b333c586575864876751b81f47f38225885e68b5eda1abbebd9abca15  eza-0.14.1.tar.gz
e6fff9bfbd2ab21c5efe96fad68f9fbe993d39459b00279901bb319118dba8046f47d62e8c18e920da689c02a9bcc1f712e8b2a27b81512f106f2203926d99e6  completions-exa.patch
"
