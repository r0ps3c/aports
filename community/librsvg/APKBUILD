# Contributor: Rasmus Thomsen <oss@cogitri.dev>
# Contributor: Natanael Copa <ncopa@alpinelinux.org>
# Maintainer: Rasmus Thomsen <oss@cogitri.dev>
pkgname=librsvg
pkgver=2.55.2
pkgrel=0
pkgdesc="SAX-based renderer for SVG files into a GdkPixbuf"
url="https://wiki.gnome.org/Projects/LibRsvg"
arch="all"
license="LGPL-2.1-or-later"
depends_dev="rsvg-convert=$pkgver-r$pkgrel"
makedepends="
	bzip2-dev
	cairo-dev
	cargo
	font-dejavu
	gi-docgen
	glib-dev
	gobject-introspection-dev
	gtk+3.0-dev
	libgsf-dev
	py3-docutils
	rust
	vala
	"
install="$pkgname.post-upgrade"
subpackages="
	$pkgname-dbg
	$pkgname-dev
	$pkgname-doc
	rsvg-convert:_convert
	rsvg-convert-doc:_convert_doc:noarch
	"
source="https://download.gnome.org/sources/librsvg/${pkgver%.*}/librsvg-$pkgver.tar.xz
	upd-cargo.patch
	"
# tests are very dependent on versions of pango/cairo/freetype
options="!check"

if [ "$CARCH" = "riscv64" ]; then
	# binutils thinks there are fake textrels
	options="$options textrels"
fi

# secfixes:
#   2.50.4-r0:
#     - RUSTSEC-2020-0146
#   2.46.2-r0:
#     - CVE-2019-20446

export RUSTFLAGS="$RUSTFLAGS -C debuginfo=1"
export CARGO_REGISTRIES_CRATES_IO_PROTOCOL="sparse"

prepare() {
	default_prepare
	git init

	# XXX: Hack to prevent rebuild on install.
	sed -Ei \
		-e 's/^(install-binSCRIPTS:) \$\(bin_SCRIPTS\)/\1/' \
		-e 's/^(install-am:) all-am/\1/' \
		Makefile.in
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libexecdir=/usr/lib/$pkgname \
		--disable-static \
		--enable-vala
	make
}

check() {
	make check
}

package() {
	make DESTDIR="$pkgdir" install
}

_convert() {
	pkgdesc="CLI utility to convert SVG files to PNG format"

	amove usr/bin/rsvg-convert
}

_convert_doc() {
	pkgdesc="CLI utility to convert SVG files to PNG format (documentation)"
	depends=""
	install_if="docs ${subpkgname%-doc}=$pkgver-r$pkgrel"

	pkgdir="$pkgdir-doc" amove usr/share/man/man1/rsvg-convert.*
}

sha512sums="
25e5ddcdf758bb0d36ce549b21800a0fc46db1e4925ec11977e3a17f2c6a504419433da526bfc3cad88e7f8afc3b0e6992f52afd326bb09b1b07eae42acbcd6b  librsvg-2.55.2.tar.xz
08739f8b18f9e9512a5ecc848ddea0374755d4348be9898170c0471a3f519825c9a45549e64c71226fe30cd4bf1fb3982e6a70f1302ecc2858bd17a417676b3f  upd-cargo.patch
"
