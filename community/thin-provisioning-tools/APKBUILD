# Contributor: Carlo Landmeter <clandmeter@alpinelinux.org>
# Maintainer:
pkgname=thin-provisioning-tools
pkgver=1.0.1
pkgrel=1
pkgdesc="suite of tools for manipulating the metadata of the dm-thin device-mapper target"
url="https://github.com/jthornber/thin-provisioning-tools"
# ucontext libc fs_type_t
arch="all !s390x"
license="GPL-3.0-or-later"
makedepends="cargo zstd-dev"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/jthornber/thin-provisioning-tools/archive/v$pkgver.tar.gz
	system-zstd.patch
	32-bit.patch
	"
# tests do a ton of disk i/o for a while..
# they pass on x86_64, but a bit too destructive to constantly run
options="!check"

case "$CARCH" in
riscv64)
	options="$options textrels"
	;;
esac

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo build --release --frozen
}

check() {
	cargo test --locked
}

package() {
	make DESTDIR="$pkgdir/usr" install
}

sha512sums="
82cabfa17d8e8b12e3973d359516ec2626d252656ad866131e35af61594155885ef98487abe6845f3a4465762fb90879e80187bb1c456549227d18a2acdb0128  thin-provisioning-tools-1.0.1.tar.gz
f4a0cd1d18e95dbc000ab3f37a927905e86d2dfebd424181c5d61003cd59a2498d7907b5ccc7515ac0946b1078a7a47cffdf2ed63762b5af14666634d6afb090  system-zstd.patch
68e5a7c373533ef260c1ce8ad3ec314d9470ed50a6b7156ab347da83bcbdfcec7c670cd86d28369c8148514709c75cdf49a02ae2a03e582f4a413b8a2c8efb2d  32-bit.patch
"
