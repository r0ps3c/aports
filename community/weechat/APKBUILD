# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Leonardo Arena <rnalrd@alpinelinux.org>
pkgname=weechat
pkgver=4.0.0
pkgrel=1
pkgdesc="A fast, light, extensible ncurses-based chat client"
url="https://weechat.org"
arch="all"
options="!check" # test suite runs "sudo make install"
license="GPL-3.0-or-later"
depends_dev="
	aspell-dev
	curl-dev
	gettext-dev
	gnutls-dev
	libgcrypt-dev
	lua-dev
	ncurses-dev
	perl-dev
	python3-dev
	ruby-dev
	zlib-dev
	zstd-dev
	"
makedepends="
	$depends_dev
	asciidoctor
	cmake
	samurai
	"
subpackages="
	$pkgname-dev
	$pkgname-doc
	$pkgname-lang
	$pkgname-spell:_plugin
	$pkgname-lua:_plugin
	$pkgname-perl
	$pkgname-python:_plugin
	$pkgname-ruby:_plugin
	"

source="
	https://www.weechat.org/files/src/weechat-$pkgver.tar.xz
	skip-broken-cs-translation-string.patch
	"

# secfixes:
#   1.7.1-r0:
#     - CVE-2017-8073
#   1.9.1-r0:
#     - CVE-2017-14727
#   2.7.1-r0:
#     - CVE-2020-8955

build() {
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DENABLE_MAN=ON \
		-DENABLE_TCL=OFF \
		-DENABLE_GUILE=OFF \
		-DENABLE_JAVASCRIPT=OFF \
		-DENABLE_PHP=OFF
	cmake --build build
}

check() {
	./tools/build-test.sh cmake
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

_plugin() {
	local _name=${subpkgname#*-}
	local _dir=usr/lib/weechat/plugins

	pkgdesc="WeeChat $_name plugin"
	depends="weechat"

	# as of 2.5 aspell has been renamed to spell on weechat upstream
	# since it now supports enchant as well, rename the subpackage and
	# replace the old one
	if [ "$_name" = spell ]; then
		replaces="$pkgname-aspell"
		provides="$pkgname-aspell=$pkgver-r$pkgrel"
	fi

	amove $_dir/"$_name".so
}

perl() {
	_plugin
	depends="$depends perl-pod-parser"
}

sha512sums="
3872ae557943433a62de13ffa549b86554d5fb40a469a172d88beb201429629a2106519812400b6ada12a1cff4a1a549a330e78cb46f958299b7524cd955a4d8  weechat-4.0.0.tar.xz
b91d555eae2bf30231c895a93eec7428bc37c990e708641fc6bf009f4b352cec8ebfb62f9d92eec1fe4cd0566821c1b56dbd705186e86b9501b02a537d854285  skip-broken-cs-translation-string.patch
"
