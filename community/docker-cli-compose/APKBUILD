# Contributor: Jake Buchholz Göktürk <tomalok@gmail.com>
# Maintainer: Jake Buchholz Göktürk <tomalok@gmail.com>
pkgname=docker-cli-compose
pkgver=2.17.3
_moby_ver=23.0.4
pkgrel=8
pkgdesc="A Docker CLI plugin for extended build capabilities"
url="https://docs.docker.com/compose/cli-command"
arch="all"
license="Apache-2.0"
depends="docker-cli"
makedepends="go"
options="net"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/docker/compose/archive/v$pkgver.tar.gz
	moby-$_moby_ver.tar.gz::https://github.com/moby/moby/archive/v$_moby_ver.tar.gz
	client-define-a-dummy-hostname-to-use-for-local-connections.patch.moby
	"

provides="docker-compose=$pkgver-r$pkgrel"

# secfixes:
#   2.15.1-r0:
#     - CVE-2022-27664
#     - CVE-2022-32149
#   2.12.1-r0:
#     - CVE-2022-39253

_plugin_installdir="/usr/libexec/docker/cli-plugins"

builddir="$srcdir"/compose-"$pkgver"

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"
export GOFLAGS="$GOFLAGS -modcacherw"

prepare() {
	default_prepare

	for f in $source; do
		case $f in
			*.patch.moby) patch -d "$srcdir"/moby-$_moby_ver -p1 <"$srcdir/$f";;
		esac
	done

	# go.mod required for any replacement to work
	(
		cd "$srcdir/moby-$_moby_ver"
		go mod init github.com/docker/docker
	)

	(
		cd "$builddir"
		go work init .
		go work use "$srcdir/moby-$_moby_ver"
	)
}

build() {
	PKG=github.com/docker/compose/v2
	local ldflags="-X '$PKG/internal.Version=v$pkgver'"
	go build -ldflags="$ldflags" -o docker-compose ./cmd
}

check() {
	# e2e tests are excluded because they depend on live dockerd/kubernetes/ecs
	local pkgs="$(go list ./... | grep -Ev '/(watch|e2e)(/|$)')"
	go test -short $pkgs
	./docker-compose compose version
}

package() {
	install -Dm755 docker-compose -t "$pkgdir$_plugin_installdir"/

	mkdir -p "$pkgdir"/usr/bin
	ln -sfv ../libexec/docker/cli-plugins/docker-compose "$pkgdir"/usr/bin/docker-compose
}

sha512sums="
a8ee444f742d22db0179de3c9dd0d78eca31c0c746923f076789c83463ae05f1b846523897683d0faae2d74bd1e3529e1e3c9952849aadfd2350c29c4398e637  docker-cli-compose-2.17.3.tar.gz
94d2c748541cf402197e98f93f574daf72bd84fc7603bf30e23674be36862ddbff5f37ad667455a710d730b9c5bc11962c287d6fd60a20320e0e0a41e3329c44  moby-23.0.4.tar.gz
811c66c0a2244eeff4d9ef7e0fdc6f5361c62d4346761c2e494f43870b2da1481ea9c112e7c8626d53c11f2ce6cfea5cab9cc7c3a758fe695d68dfaf6b0a9679  client-define-a-dummy-hostname-to-use-for-local-connections.patch.moby
"
