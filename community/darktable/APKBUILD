# Contributor: Kevin Daudt <kdaudt@alpinelinux.org>
# Maintainer: Kevin Daudt <kdaudt@alpinelinux.org>
pkgname=darktable
pkgver=5.0.1
pkgrel=0
pkgdesc="Open source photography workflow application and raw developer"
url="https://www.darktable.org/"
# aarch64: not supported with gcc
arch="x86_64 ppc64le"
license="GPL-3.0-or-later"
depends="dbus:org.freedesktop.Secrets"
makedepends="
	bash
	cmake
	colord-dev
	colord-gtk-dev
	cups-dev
	curl-dev
	exiv2-dev
	gtk+3.0-dev
	intltool
	libjpeg-turbo-dev
	json-glib-dev
	lcms2-dev
	lensfun-dev
	flickcurl-dev
	libgphoto2-dev
	libheif-dev
	libjxl-dev
	librsvg-dev
	libsecret-dev
	libwebp-dev
	libxml2-dev
	libxml2-utils
	libxslt
	lua5.4-dev
	samurai
	openexr-dev
	openjpeg-dev
	pugixml-dev
	sqlite-dev
	tiff-dev
	"
ldpath="/usr/lib/$pkgname"
subpackages="$pkgname-dbg $pkgname-doc $pkgname-lang"
options="!check" # Dependencies missing
source="https://github.com/darktable-org/darktable/releases/download/release-$pkgver/darktable-$pkgver.tar.xz
	disable-missing-musl-simd-symbol.patch
"

build() {
	local cmake_crossopts
	if [ "$CBUILD" != "$CHOST" ]; then
		cmake_crossopts="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=Release \
		-DBINARY_PACKAGE_BUILD=ON \
		-DRAWSPEED_ENABLE_LTO=ON \
		$cmake_crossopts
	cmake --build build
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
ce1550221f8806979e073be61f2e96e7fa20b38f37a673868f938e94e37000da8f27c7dd8de04b94635d2252a4d991481f7c8a9af2182285032fb52e6cf25c53  darktable-5.0.1.tar.xz
53cc6e6d587b6962feb4b3153114d99cc97173218ee971a57c1f029fdf61f73a18d14aa7aa343b67cd4a2b34e74b33f062c017140d1b1742425d09081b5e2850  disable-missing-musl-simd-symbol.patch
"
