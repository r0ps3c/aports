From 0ca07a2faf1e97b37893e8c8868280bd7052f09d Mon Sep 17 00:00:00 2001
Patch-Source: https://github.com/dotnet/runtime/pull/81573
From: Adeel <3840695+am11@users.noreply.github.com>
Date: Fri, 3 Feb 2023 01:01:10 +0200
Subject: [PATCH 1/3] Suppress clang-16 warnings

---
 eng/common/native/init-compiler.sh                        | 2 +-
 eng/native/configurecompiler.cmake                        | 8 ++++++++
 src/coreclr/dlls/mscordbi/CMakeLists.txt                  | 1 +
 src/native/corehost/apphost/static/CMakeLists.txt         | 4 ++--
 ...t_OSXexports.src => singlefilehost_freebsdexports.src} | 4 ++++
 .../apphost/static/singlefilehost_unixexports.src         | 4 ----
 6 files changed, 16 insertions(+), 7 deletions(-)
 rename src/native/corehost/apphost/static/{singlefilehost_OSXexports.src => singlefilehost_freebsdexports.src} (81%)

diff --git a/src/runtime/eng/common/native/init-compiler.sh b/src/runtime/eng/common/native/init-compiler.sh
index 41a26d8..f13b740 100644
--- a/src/runtime/eng/common/native/init-compiler.sh
+++ b/src/runtime/eng/common/native/init-compiler.sh
@@ -71,7 +71,7 @@ if [[ -z "$CLR_CC" ]]; then
     # Set default versions
     if [[ -z "$majorVersion" ]]; then
         # note: gcc (all versions) and clang versions higher than 6 do not have minor version in file name, if it is zero.
-        if [[ "$compiler" == "clang" ]]; then versions=( 15 14 13 12 11 10 9 8 7 6.0 5.0 4.0 3.9 3.8 3.7 3.6 3.5 )
+        if [[ "$compiler" == "clang" ]]; then versions=( 16 15 14 13 12 11 10 9 8 7 6.0 5.0 4.0 3.9 3.8 3.7 3.6 3.5 )
         elif [[ "$compiler" == "gcc" ]]; then versions=( 12 11 10 9 8 7 6 5 4.9 ); fi
 
         for version in "${versions[@]}"; do
diff --git a/src/runtime/eng/native/configurecompiler.cmake b/src/runtime/eng/native/configurecompiler.cmake
index 867e9ea9862e6..34fb9a51a7055 100644
--- a/src/runtime/eng/native/configurecompiler.cmake
+++ b/src/runtime/eng/native/configurecompiler.cmake
@@ -453,6 +453,15 @@ if (CLR_CMAKE_HOST_UNIX)
     add_compile_options(-Wno-incompatible-ms-struct)
 
     add_compile_options(-Wno-reserved-identifier)
+
+    # clang 16.0 introduced buffer hardening https://discourse.llvm.org/t/rfc-c-buffer-hardening/65734
+    # which we are not conforming to yet.
+    add_compile_options(-Wno-unsafe-buffer-usage)
+
+    # other clang 16.0 suppressions
+    add_compile_options(-Wno-single-bit-bitfield-constant-conversion)
+    add_compile_options(-Wno-cast-function-type-strict)
+    add_compile_options(-Wno-incompatible-function-pointer-types-strict)
   else()
     add_compile_options(-Wno-uninitialized)
     add_compile_options(-Wno-strict-aliasing)
diff --git a/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt b/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
index c24a90cf70409..ee41919ffaa6b 100644
--- a/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
+++ b/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
@@ -109,6 +109,7 @@ elseif(CLR_CMAKE_HOST_UNIX)
 
     if(CLR_CMAKE_HOST_LINUX)
         add_dependencies(mscordbi pal_redefines_file)
+        set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--undefined-version")
     endif(CLR_CMAKE_HOST_LINUX)
 
 endif(CLR_CMAKE_HOST_WIN32)
diff --git a/src/runtime/src/native/corehost/apphost/static/CMakeLists.txt b/src/runtime/src/native/corehost/apphost/static/CMakeLists.txt
index 395293a41784f..89c51af5645dd 100644
--- a/src/runtime/src/native/corehost/apphost/static/CMakeLists.txt
+++ b/src/runtime/src/native/corehost/apphost/static/CMakeLists.txt
@@ -66,8 +66,8 @@ if(CLR_CMAKE_TARGET_WIN32)
     add_linker_flag("/DEF:${CMAKE_CURRENT_SOURCE_DIR}/singlefilehost.def")
 
 else()
-    if(CLR_CMAKE_TARGET_OSX)
-        set(DEF_SOURCES ${CMAKE_CURRENT_SOURCE_DIR}/singlefilehost_OSXexports.src)
+    if(CLR_CMAKE_TARGET_FREEBSD)
+        set(DEF_SOURCES ${CMAKE_CURRENT_SOURCE_DIR}/singlefilehost_freebsdexports.src)
     else()
         set(DEF_SOURCES ${CMAKE_CURRENT_SOURCE_DIR}/singlefilehost_unixexports.src)
     endif()
diff --git a/src/runtime/src/native/corehost/apphost/static/singlefilehost_OSXexports.src b/src/runtime/src/native/corehost/apphost/static/singlefilehost_freebsdexports.src
similarity index 81%
rename from src/native/corehost/apphost/static/singlefilehost_OSXexports.src
rename to src/native/corehost/apphost/static/singlefilehost_freebsdexports.src
index 18d5697e84580..1f9c517821855 100644
--- a/src/runtime/src/native/corehost/apphost/static/singlefilehost_OSXexports.src
+++ b/src/runtime/src/native/corehost/apphost/static/singlefilehost_freebsdexports.src
@@ -9,3 +9,7 @@ g_dacTable
 
 ; Used by profilers
 MetaDataGetDispenser
+
+; FreeBSD needs to reexport these
+__progname
+environ 
diff --git a/src/runtime/src/native/corehost/apphost/static/singlefilehost_unixexports.src b/src/runtime/src/native/corehost/apphost/static/singlefilehost_unixexports.src
index 1f9c517821855..18d5697e84580 100644
--- a/src/runtime/src/native/corehost/apphost/static/singlefilehost_unixexports.src
+++ b/src/runtime/src/native/corehost/apphost/static/singlefilehost_unixexports.src
@@ -9,7 +9,3 @@ g_dacTable
 
 ; Used by profilers
 MetaDataGetDispenser
-
-; FreeBSD needs to reexport these
-__progname
-environ 

From a95105f744a4e60a67a4b1258c1bae5d67d6a23d Mon Sep 17 00:00:00 2001
From: Adeel <3840695+am11@users.noreply.github.com>
Date: Fri, 3 Feb 2023 23:54:13 +0200
Subject: [PATCH 2/3] Remove a strange (one-of-a-kind) workaround

---
 src/coreclr/dlls/mscordbi/CMakeLists.txt | 5 +----
 1 file changed, 1 insertion(+), 4 deletions(-)

diff --git a/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt b/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
index ee41919ffaa6b..fccc4e7c6fa62 100644
--- a/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
+++ b/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
@@ -100,10 +100,7 @@ elseif(CLR_CMAKE_HOST_UNIX)
         mscordaccore
     )
 
-    # COREDBI_LIBRARIES is mentioned twice because ld is one pass linker and will not find symbols
-    # if they are defined after they are used. Having all libs twice makes sure that ld will actually
-    # find all symbols.
-    target_link_libraries(mscordbi ${COREDBI_LIBRARIES} ${COREDBI_LIBRARIES})
+    target_link_libraries(mscordbi ${COREDBI_LIBRARIES})
 
     add_dependencies(mscordbi mscordaccore)
 

From dced5d027248be11e8916a181b0f0358dcc1b086 Mon Sep 17 00:00:00 2001
From: Adeel <3840695+am11@users.noreply.github.com>
Date: Fri, 3 Feb 2023 02:05:49 +0200
Subject: [PATCH 3/3] Add thunk for PAL_{Unr,R}egisterModule

---
 src/coreclr/dlls/mscordbi/CMakeLists.txt |  1 -
 src/coreclr/dlls/mscordbi/mscordbi.cpp   | 15 +++++++++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt b/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
index fccc4e7c6fa62..95e92034e238f 100644
--- a/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
+++ b/src/runtime/src/coreclr/dlls/mscordbi/CMakeLists.txt
@@ -106,7 +106,6 @@ elseif(CLR_CMAKE_HOST_UNIX)
 
     if(CLR_CMAKE_HOST_LINUX)
         add_dependencies(mscordbi pal_redefines_file)
-        set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--undefined-version")
     endif(CLR_CMAKE_HOST_LINUX)
 
 endif(CLR_CMAKE_HOST_WIN32)
diff --git a/src/runtime/src/coreclr/dlls/mscordbi/mscordbi.cpp b/src/runtime/src/coreclr/dlls/mscordbi/mscordbi.cpp
index 891c01e144f5c..109fe6a5b5417 100644
--- a/src/runtime/src/coreclr/dlls/mscordbi/mscordbi.cpp
+++ b/src/runtime/src/coreclr/dlls/mscordbi/mscordbi.cpp
@@ -32,3 +32,18 @@ BOOL WINAPI DllMain(HINSTANCE hInstance, DWORD dwReason, LPVOID lpReserved)
 	// Defer to the main debugging code.
     return DbgDllMain(hInstance, dwReason, lpReserved);
 }
+
+#if defined(HOST_LINUX) && defined(TARGET_LINUX)
+PALIMPORT HINSTANCE PALAPI DAC_PAL_RegisterModule(IN LPCSTR lpLibFileName);
+PALIMPORT VOID PALAPI DAC_PAL_UnregisterModule(IN HINSTANCE hInstance);
+
+HINSTANCE PALAPI PAL_RegisterModule(IN LPCSTR lpLibFileName)
+{
+     return DAC_PAL_RegisterModule(lpLibFileName);
+}
+
+VOID PALAPI PAL_UnregisterModule(IN HINSTANCE hInstance)
+{
+    DAC_PAL_UnregisterModule(hInstance);
+}
+#endif
