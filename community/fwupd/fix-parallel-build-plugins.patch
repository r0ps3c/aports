Patch-Source: https://github.com/fwupd/fwupd/pull/6136.patch
--
From d1b7e5bb31b11346a7366b07d86854f54ea52bc7 Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Thu, 31 Aug 2023 17:19:29 +0100
Subject: [PATCH 1/3] trivial: Rename the list of fwupdplugin rs targets

---
 libfwupdplugin/meson.build | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/libfwupdplugin/meson.build b/libfwupdplugin/meson.build
index 868a5e75fc..556f0e37f5 100644
--- a/libfwupdplugin/meson.build
+++ b/libfwupdplugin/meson.build
@@ -30,9 +30,9 @@ fwupdplugin_structs = [
 ]
 
 # do not use structgen as these are referenced in headers too...
-fwupdplugin_struct_targets = []
+fwupdplugin_rs_targets = []
 foreach fwupdplugin_struct: fwupdplugin_structs
-  fwupdplugin_struct_targets += custom_target('lib' + fwupdplugin_struct,
+  fwupdplugin_rs_targets += custom_target('lib' + fwupdplugin_struct,
     input: fwupdplugin_struct,
     output: [
       fwupdplugin_struct.replace('.rs', '-struct.c'),
@@ -298,7 +298,7 @@ library_deps = [
 
 fwupdplugin = library(
   'fwupdplugin',
-  fwupdplugin_struct_targets,
+  fwupdplugin_rs_targets,
   sources: [
     fwupdplugin_src,
     fwupdplugin_headers,
@@ -338,7 +338,7 @@ if introspection.allowed()
     sources: [
       fwupdplugin_src,
       fwupdplugin_headers,
-      fwupdplugin_struct_targets,
+      fwupdplugin_rs_targets,
     ],
     nsversion: '1.0',
     namespace: 'FwupdPlugin',

From c8a133575f27fa8af8db73372c4696bf6f6b3dc6 Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Thu, 31 Aug 2023 17:20:18 +0100
Subject: [PATCH 2/3] trivial: Add an explicit dep on plugin generated headers

---
 plugins/dfu-csr/meson.build | 1 +
 plugins/elanfp/meson.build  | 1 +
 2 files changed, 2 insertions(+)

diff --git a/plugins/dfu-csr/meson.build b/plugins/dfu-csr/meson.build
index 5c65b3364c..1612947f7a 100644
--- a/plugins/dfu-csr/meson.build
+++ b/plugins/dfu-csr/meson.build
@@ -4,6 +4,7 @@ cargs = ['-DG_LOG_DOMAIN="FuPluginDfuCsr"']
 plugin_quirks += files('dfu-csr.quirk')
 plugin_builtins += static_library('fu_plugin_dfu_csr',
   sources: [
+    dfu_rs[1], # header
     'fu-dfu-csr-device.c',
     'fu-dfu-csr-plugin.c',
   ],
diff --git a/plugins/elanfp/meson.build b/plugins/elanfp/meson.build
index abab8f9e2d..d69f5f2d7a 100644
--- a/plugins/elanfp/meson.build
+++ b/plugins/elanfp/meson.build
@@ -4,6 +4,7 @@ cargs = ['-DG_LOG_DOMAIN="FuPluginElanfp"']
 plugin_quirks += files('elanfp.quirk')
 plugin_builtins += static_library('fu_plugin_elanfp',
   sources: [
+    cfu_rs[1], # header
     'fu-elanfp-plugin.c',
     'fu-elanfp-device.c',
     'fu-elanfp-firmware.c'  # fuzzing

From 710dbe76f7a3ab55d1158230e1be2a734aa450fe Mon Sep 17 00:00:00 2001
From: Richard Hughes <richard@hughsie.com>
Date: Thu, 31 Aug 2023 17:21:12 +0100
Subject: [PATCH 3/3] Add libfwupdplugin generated structs as input to all
 built-in plugins

Inspired by a patch from Jeremy Soller <jackpot51@gmail.com>, many thanks.
---
 libfwupdplugin/meson.build | 7 +++++++
 plugins/meson.build        | 1 +
 2 files changed, 8 insertions(+)

diff --git a/libfwupdplugin/meson.build b/libfwupdplugin/meson.build
index 556f0e37f5..70f67ec2c9 100644
--- a/libfwupdplugin/meson.build
+++ b/libfwupdplugin/meson.build
@@ -317,6 +317,13 @@ fwupdplugin = library(
   install: true
 )
 
+# see https://mesonbuild.com/FAQ.html#how-do-i-tell-meson-that-my-sources-use-generated-headers
+fwupdplugin_rs_headers = []
+foreach fwupdplugin_rs_target: fwupdplugin_rs_targets
+  fwupdplugin_rs_headers += fwupdplugin_rs_target[1]
+endforeach
+fwupdplugin_rs_dep = declare_dependency(link_with: fwupdplugin, sources: fwupdplugin_rs_headers)
+
 if introspection.allowed()
   gir_dep = declare_dependency(sources: fwupd_gir)
   girtargets = []
diff --git a/plugins/meson.build b/plugins/meson.build
index f7880e96b2..24f77fd258 100644
--- a/plugins/meson.build
+++ b/plugins/meson.build
@@ -10,6 +10,7 @@ plugin_deps = [
   libjsonglib,
   libxmlb,
   protobufc,
+  fwupdplugin_rs_dep,
 ]
 
 plugins = [
