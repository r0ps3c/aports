# Maintainer: Simon Zeni <simon@bl4ckb0ne.ca>
# Contributor: Fabricio Silva <hi@fabricio.dev>
pkgname=jellyfin
pkgver=10.10.2
pkgrel=0
pkgdesc="The Free Software Media System"
install="$pkgname.pre-install"
url="https://jellyfin.org/"
arch="x86_64"
license="GPL-2.0-only"
makedepends="dotnet8-sdk"
depends="aspnetcore8-runtime jellyfin-ffmpeg"
subpackages="$pkgname-openrc"
source="$pkgname-$pkgver.tar.gz::https://github.com/jellyfin/jellyfin/archive/refs/tags/v$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	relax-dotnet-version.patch
	"

build() {
	dotnet publish Jellyfin.Server \
		--configuration Release \
		--no-self-contained \
		--use-current-runtime \
		--output publish
}

check() {
	dotnet test --no-restore
}

package() {
	mkdir -p "$pkgdir"/usr/lib "$pkgdir"/usr/bin

	cp -a publish "$pkgdir"/usr/lib/jellyfin
	ln -s ../lib/jellyfin/jellyfin "$pkgdir"/usr/bin/jellyfin

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
da709cdb04ba5b0517ee69965e33034b33d05914be66b720642befd5239c9d8c9652e1a536bf6d7c96e2fba5c6fbefbe671d99239fa2634b0bb112b10df6e96c  jellyfin-10.10.2.tar.gz
bcdb882b837a08e4c1db363fbf2a075f0d6558a537c3f798b1473f9f1b5b887b6da1928558b0aede8bf56ab16469ac9e80dc95b0f874533ad744465a92b37696  jellyfin.initd
594c26e5235ae2265f3f586f596cd6b57fa0e0cec83531b6fadba48181870167f04381266c6005f1f6cb5cd76d254100a08a871ecb8da28e5890f979816a7b8b  jellyfin.confd
38e4db175fe2ed9b9fca2c81e046a4a94ce60c6b36be14abdf2b9301f213cdb647f71b7437d34a47976ef4a71145b2666dc94053d4c53cbb63e47f2ee595a235  relax-dotnet-version.patch
"
