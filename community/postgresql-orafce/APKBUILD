# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=postgresql-orafce
_pkgname=orafce
pkgver=4.9.1
_pkgver=VERSION_${pkgver//./_}
pkgrel=0
pkgdesc="Oracle's compatibility functions and packages for PostgreSQL"
url="https://github.com/orafce/orafce"
arch="all"
license="0BSD"
makedepends="bison flex postgresql-dev"
subpackages="
	$pkgname-bitcode
	$pkgname-doc
	"
source="$pkgname-$pkgver.tar.gz::https://github.com/orafce/$_pkgname/archive/$_pkgver.tar.gz"
builddir="$srcdir/$_pkgname-$_pkgver"
options="!check"  # XXX: installcheck requires running PostgreSQL

build() {
	make USE_PGXS=1 all
}

package() {
	_pgver=$(pg_config --major-version)
	depends="postgresql$_pgver"

	make USE_PGXS=1 DESTDIR="$pkgdir" install

	cd "$pkgdir"
	mv ./usr/share/doc/postgresql$_pgver/extension \
		./usr/share/doc/$pkgname
	rmdir ./usr/share/doc/postgresql$_pgver
}

bitcode() {
	_pgver=$(pg_config --major-version)
	pkgdesc="$pkgdesc (bitcode for JIT)"
	depends="$pkgname=$pkgver-r$pkgrel"
	install_if="postgresql$_pgver-jit $pkgname=$pkgver-r$pkgrel"

	amove usr/lib/postgresql*/bitcode
}

sha512sums="
f703924cd370c74ae6ec4185c0fcfea5254c2f4fc461232c93cec7cade0dec9152f3f29969c59f35c3026a4922b3e0de897288247e9bbdaf7422311d8757ec35  postgresql-orafce-4.9.1.tar.gz
"
