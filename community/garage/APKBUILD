# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=garage
pkgver=0.9.4
pkgrel=0
pkgdesc="Lightweight S3-compatible distributed object store"
url="https://garagehq.deuxfleurs.fr"
# armhf,armv7,x86: fails to build (std::bad_alloc)
# riscv64: would take eternity to build
# s390x: fails to build nix crate
arch="all !armhf !armv7 !x86 !riscv64 !s390x"
license="AGPL-3.0"
makedepends="
	cargo
	cargo-auditable
	libsodium-dev
	protoc
	sqlite-dev
	zstd-dev
	"
checkdepends="openssl-dev"
pkgusers="garage"
pkggroups="garage"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="$pkgname-openrc"
source="https://github.com/deuxfleurs-org/garage/archive/v$pkgver/garage-$pkgver.tar.gz
	garage.toml
	$pkgname.initd
	$pkgname.confd
	"

case "$CARCH" in
	# Fails to build ring crate.
	ppc64le | s390x) options="!check";;
esac

# Disable bundled-libs, metrics, sqlite, sled, k2v
_cargo_opts="--frozen --no-default-features --features lmdb,syslog,system-libs"

export CARGO_PROFILE_RELEASE_OPT_LEVEL=2

export SODIUM_USE_PKG_CONFIG=1
export GIT_VERSION="v$pkgver"  # version used in --version

prepare() {
	default_prepare

	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build $_cargo_opts --release
}

check() {
	cargo test $_cargo_opts --workspace
}

package() {
	install -D -m755 target/release/$pkgname -t "$pkgdir"/usr/bin/

	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
	install -D -m640 -o garage -g garage "$srcdir"/garage.toml -t "$pkgdir"/etc/

	install -d -m700 -o garage -g garage "$pkgdir"/var/lib/$pkgname
}

sha512sums="
c948f1a8bf962d66be13ec11548ad11320c4778d6ebbdcff2d71c5b642519f6eb1cbed359b57fd444d93d31f84a266002f90d157dfb107a5fa161b3d80d2cca6  garage-0.9.4.tar.gz
1a0c0c02aa41043274cb3f1dfeb2e2621e24c198e33ebf8ed15c9e0f63b4d4c43be680bc895cf55688ebfe751d71463255e956fdc070c28d85c400444a5589bb  garage.toml
e0f0a285f025d12bc03a32c2cde387360bfe0a1a64f0b11c7e77b0e6b2730f03a6e3e1b909be642bb04b152705903c31bf92ba06cf3f4b85f0a6cdf1906d6d6d  garage.initd
f31bb5bde3ff41dc5fa6832c8ff24e1f1027b34513ab5e5c008df13495b53a569d3cb5adefed93cf780f5e488ff760603097785d85e1a884538e802e415205bd  garage.confd
"
