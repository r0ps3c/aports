# Contributor: August Klein <amatcoder@gmail.com>
# Maintainer: Andr√© Klitzing <aklitzing@gmail.com>
pkgname=cppcheck
pkgver=2.14.0
pkgrel=0
pkgdesc="Static analysis tool for C/C++ code"
url="https://cppcheck.sourceforge.io/"
arch="all"
license="GPL-3.0-or-later"
makedepends="
	cmake
	docbook-xsl
	pcre-dev
	python3
	qt6-qtcharts-dev
	qt6-qttools-dev
	samurai
	tinyxml2-dev
	"
subpackages="$pkgname-doc $pkgname-htmlreport::noarch $pkgname-gui"
source="$pkgname-$pkgver.tar.gz::https://github.com/danmar/cppcheck/archive/refs/tags/$pkgver.tar.gz
	set_datadir.patch
	feenableexcept.patch
	"

build() {
	make DB2MAN=/usr/share/xml/docbook/xsl-stylesheets-*/manpages/docbook.xsl man

	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DBUILD_GUI=ON \
		-DBUILD_TESTS="$(want_check && echo ON || echo OFF)" \
		-DFILESDIR=/usr/share/cppcheck \
		-DHAVE_RULES=ON \
		-DUSE_BUNDLED_TINYXML2=OFF \
		-DUSE_MATCHCOMPILER=On \
		-DUSE_QT6=ON \
		-DWITH_QCHART=ON

	cmake --build build
}

check() {
	# fails outside of x86 with:
	# Expected:
	# [test.cpp:5]: (style) Condition 'buffer.back()=='\0'' is always false\n
	# Actual:
	# [test.cpp:3] -> [test.cpp:5]: (style) Condition 'buffer.back()=='\0'' is always false\n
	# TestThreadExecutor: flaky result

	ctest -E "(TestCondition|TestThreadExecutor)" --test-dir build --output-on-failure
}

package() {
	DESTDIR="$pkgdir" cmake --install build
	install -Dm644 cppcheck.1 -t "$pkgdir"/usr/share/man/man1
	install -Dm755 htmlreport/cppcheck-htmlreport -t "$pkgdir"/usr/bin

	mkdir -p "$pkgdir"/usr/share/cppcheck/lang
	mv "$pkgdir"/usr/bin/cppcheck*.qm "$pkgdir"/usr/share/cppcheck/lang
}

htmlreport() {
	pkgdesc="Utility to generate a html report of a XML file produced by cppcheck"
	depends="$pkgname=$pkgver-r$pkgrel python3 py3-pygments"

	amove usr/bin/cppcheck-htmlreport
}

gui() {
	pkgdesc="Qt gui for cppcheck"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove usr/bin/cppcheck-gui
	amove usr/share/cppcheck/lang
	amove usr/share/icons
	amove usr/share/applications
}

sha512sums="
77ea3f92b3a83979ba9c6042cf8a937c8d7a6915c2c840755bc2f7bb79c6bc625cb7a515714d23fa57abe4110764e35476bb8e44ec87d2ac034ab33720a8267e  cppcheck-2.14.0.tar.gz
2e1d1fe1ba66c091cdd33f2c883370ea216718b2e7b997717623dd36cd73a9b82fa116144d93b7a4f3ab6bfea1c49274c950e751fdda45a61160d3cef913ea88  set_datadir.patch
d483e39b4b5b6482081f656708433b6f45da3e9e7ba4adf9c6ff347273cae7cc6bf854248d460278f39054b36582aa009d9ce3b87d55dc4efe1f45cc865c6cc4  feenableexcept.patch
"
