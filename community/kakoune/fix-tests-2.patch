Patch-Source: https://github.com/mawww/kakoune/commit/0e92b3fdefddbf81a008b3678faf4bf550be215c
--
From 0e92b3fdefddbf81a008b3678faf4bf550be215c Mon Sep 17 00:00:00 2001
From: Maxime Coste <mawww@kakoune.org>
Date: Sun, 12 May 2024 14:18:17 +1000
Subject: [PATCH] Fix another case where git tests were hanging

---
 rc/tools/git.kak                    | 2 +-
 test/run                            | 2 +-
 test/tools/git/blame-in-diff/script | 4 ++--
 3 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/rc/tools/git.kak b/rc/tools/git.kak
index ac349a9719..def591d860 100644
--- a/rc/tools/git.kak
+++ b/rc/tools/git.kak
@@ -224,7 +224,7 @@ define-command -params 1.. \
                         execute-keys <a-l><semicolon><a-?>^commit<ret><a-semicolon>
                     } catch %{
                         # Missing commit line, assume it is an uncommitted change.
-                        execute-keys <a-l><semicolon><a-?>\A<ret><a-semicolon>
+                        execute-keys <a-l><semicolon>Gg<a-semicolon>
                     }
                     require-module diff
                     try %{
diff --git a/test/run b/test/run
index e26aea054e..a65f539677 100755
--- a/test/run
+++ b/test/run
@@ -193,7 +193,7 @@ ui_out() {
     -until)
       shift
       while read -r event <&4; do
-        [ "$event" == "$1" ] && break
+        [ "$event" = "$1" ] && break
       done
       ;;
     -until-grep)
diff --git a/test/tools/git/blame-in-diff/script b/test/tools/git/blame-in-diff/script
index 6adda9225f..e22b3ec8ae 100644
--- a/test/tools/git/blame-in-diff/script
+++ b/test/tools/git/blame-in-diff/script
@@ -1,9 +1,9 @@
-ui_out -until '{ "jsonrpc": "2.0", "method": "refresh", "params": [true] }'
+ui_out -until '{ "jsonrpc": "2.0", "method": "refresh", "params": [false] }'
 
 # We've jumped to the new version of line 2. Move to the old version so we
 # can annotate the old file.
 ui_in '{ "jsonrpc": "2.0", "method": "keys", "params": [ "k:git blame<ret>" ] }'
-ui_out -until '{ "jsonrpc": "2.0", "method": "refresh", "params": [false] }'
+while ui_out -until-grep '"draw_status"' | grep '\[fifo\]'; do :; done > /dev/null
 
 # We should have jumped to the old version of line 2, assert on kak_selection.
 ui_in '{ "jsonrpc": "2.0", "method": "keys", "params": [ "x" ] }'
