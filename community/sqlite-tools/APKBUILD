# Maintainer: Celeste <cielesti@protonmail.com>
pkgname=sqlite-tools
pkgver=3.45.3
pkgrel=0
pkgdesc="Helper tools for SQLite"
url="https://www.sqlite.org/"
arch="all"
license="blessing"
makedepends="readline-dev sqlite-dev tcl-dev"
checkdepends="bash"
subpackages="sqlite-analyzer"

# compute _ver
_a=${pkgver%%.*}
_b=${pkgver#"$_a".}
_b=${_b%%.*}
_c=${pkgver#"$_a"."$_b".}
_c=${_c%%.*}
case $pkgver in
	*.*.*.*)_d=${pkgver##*.};;
	*.*.*)	_d=0;;
esac
[ $_b -lt 10 ] && _b=0$_b
[ $_c -lt 10 ] && _c=0$_c
[ $_d -lt 10 ] && _d=0$_d
_ver=${_a}${_b}${_c}$_d

# these variables depend on _ver being set
source="https://www.sqlite.org/2024/sqlite-src-$_ver.zip
	date4-test-musl.patch
	func4-test-x86.patch
	stdout-invalid-argument.patch
	"
builddir="$srcdir/sqlite-src-$_ver"

_tools="showdb showjournal showstat4 showwal sqldiff sqlite3_analyzer"

prepare() {
	default_prepare

	if [ -f "$startdir"/../../main/sqlite/APKBUILD ]; then
	_amalgamation=$(
		_toolsver=$pkgver
		# shellcheck disable=SC1091
		. "$startdir"/../../main/sqlite/APKBUILD
		if [ "$_toolsver" != "$pkgver" ]; then
			die "sqlite version mismatch ($_toolsver != $pkgver)"
		fi
		echo "$_amalgamation"
		)
	fi
}

build() {
	export CFLAGS="$CFLAGS $_amalgamation"

	# configure options copied from main/sqlite
	./configure \
		--build="$CBUILD" \
		--host="$CHOST" \
		--prefix=/usr \
		--enable-threadsafe \
		--enable-readline \
		--enable-static \
		--enable-dynamic-extensions \
		--enable-fts3 \
		--enable-fts4 \
		--enable-fts5

	make sqlite3_analyzer

	local tool; for tool in ${_tools//sqlite3_analyzer}; do
		msg "Building $tool"
		${CC:-gcc} $CFLAGS $LDFLAGS \
			-o $tool tool/$tool.c -lsqlite3
	done

	# test at the same optimization level as main/sqlite
	want_check && make CFLAGS="${CFLAGS//-Os/-O2}" testfixture
}

check() {
	# error reporting is much better with the non-parallel
	# "tcltest", but riscv64 is slow, taking 30 minutes to
	# complete in CI, so parallelize it with "testrunner"

	case "$CARCH" in
	riscv64)
		make testrunner
		;;
	*)
		make tcltest
		;;
	esac
}

package() {
	install -Dvm755 $_tools -t "$pkgdir"/usr/bin/
}

analyzer() {
	pkgdesc="Analyze space utilization of SQLite database files"

	amove usr/bin/sqlite3_analyzer
}

sha512sums="
8f44ffdefd2cf09e7edb7cd78d5416fe7b42e01fe4b4e4803ce9d34c7b1b2971ec170a908a94b4bb11737dd3888675c8ff101ff2b41c53b8db05b5954e947cc9  sqlite-src-3450300.zip
5bd1df589b9fe965423493fedbb85537dbc21cc1fda49eee42a8fbed4602ca17e3421d597b50cf81c0a47a81607d29c7295213a9f308b45b5aae3f8d702d680b  date4-test-musl.patch
ae5bdffe59ce6a9814deecad000a2c0e194359f0143dcde6f28dcdc8c13c0275598544c79483022b4c8840a46c58a495003d00502d69e43484445201365cd464  func4-test-x86.patch
cd976a64a3721dec1fb465bf337f30bb14e35ee94f4fec3d2667630853f30f9f489ef60c96a8789de4ceb05463396c529ee03a0b8aa3745ea161aac008425059  stdout-invalid-argument.patch
"
