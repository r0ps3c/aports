# Maintainer: Thiago Perrotta <tbperrotta@gmail.com>
pkgname=argocd
pkgver=3.0.0
pkgrel=2
pkgdesc="Declarative continuous deployment for Kubernetes"
url="https://argo-cd.readthedocs.io/"
arch="all !armhf !armv7 !x86"
license="Apache-2.0"
makedepends="go make"
options="net"
subpackages="$pkgname-doc $pkgname-bash-completion $pkgname-zsh-completion"
source="argo-cd-$pkgver.tar.gz::https://github.com/argoproj/argo-cd/archive/v$pkgver.tar.gz"
builddir="$srcdir/argo-cd-$pkgver"

build() {
	# FIXME: "_cgo_pthread_key_created missing" failure at runtime
	case "$CARCH" in
		s390x|riscv64) export GOFLAGS="${GOFLAGS//-buildmode=pie/}" ;;
	esac

	make CGO_FLAG=1 LDFLAGS="" cli-local

	dist/argocd completion bash > argocd.bash
	dist/argocd completion zsh > argocd.zsh
}

check() {
	dist/argocd version | grep -q "argocd: v${pkgver}"
}

package() {
	install -Dm755 "dist/argocd" "$pkgdir/usr/bin/argocd"

	install -Dm644 argocd.bash "$pkgdir/usr/share/bash-completion/completions/argocd"
	install -Dm644 argocd.zsh "$pkgdir/usr/share/zsh/site-functions/_argocd"

	install -Dm644 LICENSE "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
}

sha512sums="
f70443e61fb44c5bbe051d5109fd8aea9e98bf024e77c9425906126dadef0c1e0bfdd6d5b383a48365443dd6159f1fe30a130c73ce9db9481f2cac13c0416c06  argo-cd-3.0.0.tar.gz
"
