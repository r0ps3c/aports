# Contributor: Ralf Rachinger <alpine@ralfrachinger.de>
# Maintainer: Ralf Rachinger <alpine@ralfrachinger.de>
pkgname=cinny
pkgver=2.2.4
_releasedate="2023-01-30"
pkgrel=1
pkgdesc="Yet another matrix client"
url="https://cinny.in"
# limited by tauri platform support
arch="x86_64 x86 aarch64 armv7"
license="MIT"
depends="gst-plugins-good"
makedepends="
	cargo
	gtk+3.0-dev
	nodejs
	npm
	openssl-dev
	tauri-cli
	vips-dev
	webkit2gtk-dev
	"
# Adapted from https://github.com/flathub/in.cinny.Cinny
source="
	cinny-$pkgver.zip::https://github.com/cinnyapp/cinny-desktop/releases/download/v$pkgver/cinny-desktop-v$pkgver.zip
	0001-disable-tauri-updater.patch
	CVE-2023-28427.patch
	in.cinny.Cinny.appdata.xml.in
	in.cinny.Cinny.desktop
"
builddir="$srcdir/cinny-desktop"
_jsdir="$builddir/cinny"
_rustdir="$builddir/src-tauri"
options="net !check" # no checks

# secfixes:
#   2.2.4-r1:
#     - CVE-2023-28103

export CARGO_PROFILE_RELEASE_OPT_LEVEL=2
export CARGO_REGISTRIES_CRATES_IO_PROTOCOL="sparse"
export NODE_OPTIONS="--max-old-space-size=4000"

prepare() {
	default_prepare

	# they don't know how to specify dependencies correctly
	cd "$_jsdir"
	npm ci --legacy-peer-deps

	cd "$builddir"
	npm ci

	cd "$_rustdir"
	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo tauri build -b "none"
}

package() {
	install -Dm755 -t "$pkgdir"/usr/bin "$_rustdir"/target/release/cinny

	install -Dm644 -t "$pkgdir"/usr/share/applications/ "$srcdir"/in.cinny.Cinny.desktop

	# Generate appdata file
	mkdir -p "$pkgdir"/usr/share/metainfo/
	export DATE="$_releasedate"
	export VERSION="$pkgver-$pkgrel"
	envsubst < "$srcdir"/in.cinny.Cinny.appdata.xml.in > "$pkgdir"/usr/share/metainfo/in.cinny.Cinny.appdata.xml

	install -Dm644 "$_rustdir"/icons/32x32.png "$pkgdir"/usr/share/icons/hicolor/32x32/apps/cinny.png
	install -Dm644 "$_rustdir"/icons/128x128.png "$pkgdir"/usr/share/icons/hicolor/128x128/apps/cinny.png
	install -Dm644 "$_rustdir"/icons/128x128@2x.png	"$pkgdir"/usr/share/icons/hicolor/256x256/apps/cinny.png
	install -Dm644 "$_rustdir"/icons/icon.png "$pkgdir"/usr/share/icons/hicolor/512x512/apps/cinny.png
}

sha512sums="
7e10d56bb612f708109335a37cf598ada26d376ebf4009cb04283c00e4deec8ac8b22e3337b9d8e578289ebe846266d3fbb325cbde14136f3e81198778264d58  cinny-2.2.4.zip
882fffa59d8cda7a8dcc424f02af46c2dec078c3484122e27646fa18501c529129c3b084227c59096bae738dec266a45388afcd080adf929ffb707168926ad36  0001-disable-tauri-updater.patch
3ec016126a1249a1a2435580d20bfcacc65af9b40926c6d8fc69ffa8e9760ffb83d01dd5634d979e8b4a485af9dc4e18b412a6dcb908ea3887db5432a879f096  CVE-2023-28427.patch
215262a8ace51aa679398e0e6e849e853809938026665bfe9bf704cb49f9ee6d02c7bffdaf79296cef5c478006d12d95dcc6fb3fa2e178783cccee322e897b7a  in.cinny.Cinny.appdata.xml.in
29b3afefa5af3b5463e8903802e7f4e0374b97c5c0b56fda920cdb6352cad95827621e1a7d51e86a82defab9852bda15e505e69b85eac653cd8aa2c4dd813029  in.cinny.Cinny.desktop
"
