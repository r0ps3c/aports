# Contributor: Piper McCorkle <piper@cloudflare.com>
# Maintainer: Piper McCorkle <piper@cloudflare.com>
pkgname=cloudflared
pkgver=2023.5.0
pkgrel=1
pkgdesc="Cloudflare Tunnel client"
url="https://github.com/cloudflare/cloudflared"
arch="aarch64 x86 x86_64"
license="Apache-2.0"
makedepends="go gettext"
subpackages="$pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/cloudflare/cloudflared/archive/refs/tags/$pkgver.tar.gz
	goflags.patch
	go1.20.patch
	"
options="!check" # require privileged icmp sockets

export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

prepare() {
	default_prepare
	go mod vendor
}

build() {
	make cloudflared
	DATE="2023" VERSION="$pkgver" envsubst < cloudflared_man_template > cloudflared.1
}

check() {
	_goarch=$(go tool dist env | grep GOARCH | sed 's/^GOARCH="//; s/"$//')
	# Go race detector is only supported on amd64, ppc64le, and arm64
	if [ $_goarch = "amd64" ] || [ $_goarch = "ppc64le" ] || [ $_goarch = "arm64" ]; then
		_race=-race
	fi
	go test -mod=vendor -buildmode=default $_race ./...
}

package() {
	install -D -m755 ./cloudflared "$pkgdir"/usr/bin/cloudflared
	install -D -m644 ./cloudflared.1 "$pkgdir"/usr/share/man/man1/cloudflared.1
}

sha512sums="
917a4c9ff27dfbcbd5324fdd7397e2242815ce30d00c95a45a6a28722af0aa7305d26f8f7e67c8c69410a18953bd0c9361da76b78bd1c2abe67c6c4b43245034  cloudflared-2023.5.0.tar.gz
deb54b26ac89da74f6d1016deebdd2a15e302d49c1c2b83787b905e70b00250ddf9568d078c4d1d7b53bba9ab1aa182fbcadca2376a7008f07ce4502a4c6f91c  goflags.patch
2285b08f0bee879e3d36058724b6c1eaa69e1e8c938c25e2797066eecd021eca994953cf785163f7e0a8a1acd7edd46f2622b5b37d9eb5dcd6de3feca447c7d3  go1.20.patch
"
