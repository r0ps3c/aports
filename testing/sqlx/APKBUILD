# Contributor: Matthias Ahouansou <matthias@ahouansou.cz>
maintainer="Matthias Ahouansou <matthias@ahouansou.cz>"
pkgname=sqlx
pkgver=0.8.3
pkgrel=0
pkgdesc="Command-line utility for SQLx, the Rust SQL toolkit"
url="https://github.com/launchbadge/sqlx"
arch="all"
license="MIT OR Apache-2.0"
makedepends="
	cargo
	cargo-auditable
	clang-dev
	openssl-dev
	sqlite-dev
"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-zsh-completion
	$pkgname-fish-completion
	cargo-$pkgname:cargosqlx
"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/launchbadge/sqlx/archive/refs/tags/v$pkgver.tar.gz
	bump-deps.patch
	replace-promptly-with-dialoguer.patch
	use-u64.patch
"
options="net"

_cargo_args="-p sqlx-cli --frozen"

prepare() {
	default_prepare
	cargo fetch --target="$CTARGET" --locked
}

build() {
	cargo auditable build --release --features sqlite-unbundled $_cargo_args
}

check() {
	cargo test --features sqlite-unbundled $_cargo_args
}

package() {
	install -Dm 755 target/release/sqlx "$pkgdir"/usr/bin/sqlx

	for l in -APACHE -MIT
	do
		install -Dm 644 LICENSE"$l" "$pkgdir"/usr/share/licenses/"$pkgname"/LICENSE"$l"
	done

	install -d "$pkgdir"/usr/share/bash-completion/completions \
		"$pkgdir"/usr/share/zsh/site-functions \
		"$pkgdir"/usr/share/fish/vendor_completions.d
	"$pkgdir"/usr/bin/sqlx completions bash > "$pkgdir"/usr/share/bash-completion/completions/sqlx
	"$pkgdir"/usr/bin/sqlx completions zsh > "$pkgdir"/usr/share/zsh/site-functions/_sqlx
	"$pkgdir"/usr/bin/sqlx completions fish > "$pkgdir"/usr/share/fish/vendor_completions.d/sqlx.fish

}

cargosqlx() {
	pkgdesc="$pkgdesc - cargo subcommand"
	depends="cargo"
	install_if="$pkgname=$pkgver-r$pkgrel cargo"

	install -Dm 755 "$builddir"/target/release/cargo-sqlx "$subpkgdir"/usr/bin/cargo-sqlx
}

sha512sums="
b8f1da65fc6bdd7a3a2b1345f028cbcf3c2fa9df23827e99d2283743378f6ec3d4557c82520e6448e98e05b2b3b5ba3b5264318d0ce7eba23786a0e10a3ce4de  sqlx-0.8.3.tar.gz
cdb2067de93fdb1b2ec4df8ca8f4877b153392e54bca2ff57bd4b28b45687ee7be94cc9fde7f0bb2843d6db3d430e49daa1f71bdc80b2e5f6c9ed960e5c7cb46  bump-deps.patch
6dfc99675b90c9aa6360d5c007d193d4ad773a1d02529fc026f51c11faeb6b5b780da02a2028280036e24dc69e332bce020726bcb5b91773d873433066e40f7b  replace-promptly-with-dialoguer.patch
779411627cefae0bf309a7754dee69c699ef1fb3b7e535ebda3ef3ac25c0e7d4e7655b3ddae0ebe6693c764751c9695c28f30de51474539335e912280a408870  use-u64.patch
"
