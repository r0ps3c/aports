# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=addrwatch
pkgver=1.0.2
pkgrel=0
pkgdesc="IPv4/IPv6 and ethernet address pairing monitoring"
url="https://github.com/fln/addrwatch"
arch="all"
license="GPL-3.0-only"
makedepends="
	argp-standalone
	autoconf
	automake
	libevent-dev
	libpcap-dev
	mariadb-connector-c-dev
	sqlite-dev
	"
pkgusers="addrwatch"
pkggroups="addrwatch"
install="$pkgname.pre-install"
subpackages="
	$pkgname-mysql
	$pkgname-doc
	$pkgname-openrc
	"
source="https://github.com/fln/addrwatch/archive/v$pkgver/addrwatch-$pkgver.tar.gz
	use-HOST_NAME_MAX-macro.patch
	more-specific-library-linking.patch
	$pkgname.initd
	$pkgname.confd
	"
options="!check"  # no tests provided

prepare() {
	default_prepare
	./bootstrap.sh
}

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--localstatedir=/var \
		--enable-mysql \
		--enable-sqlite3
	make
}

package() {
	make install DESTDIR="$pkgdir"

	install -D -m755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -D -m644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname

	install -d -m750 -o addrwatch -g addrwatch "$pkgdir"/var/lib/$pkgname
}

mysql() {
	pkgdesc="$pkgdesc - with MySQL output"
	depends="$pkgname=$pkgver-r$pkgrel"

	amove usr/bin/addrwatch_mysql
}

sha512sums="
b0b1f246aadc8512dc5d9b44a21f8add9775aa7329520e47caafa2beaa74f6cd1a08d79c119c52fecf86adf93210c17ab050a1e3f94b079b1724fbdf015986a9  addrwatch-1.0.2.tar.gz
e1901e5e4b247dd47d73b5aab11e606dec45de6786e4ffefb7cd20dc5dc2e21c718f9e2f9670157e7f402465a749a42d4d88152eac5130c20f3060753510518a  use-HOST_NAME_MAX-macro.patch
590baf828610fba24d321de86f93187069be0bf672cd64983a3af325792b3df6506b5b292dce1dce729aaed134fa1223f7e67b63bee3ced5be3791bdb3846731  more-specific-library-linking.patch
29214eca19d7b8ebd6540329833de675d007cb1773eed645a22c6f78bbaf82e1fe801bca430b28601992f108d6e713af33859300f63da2b264cab2dfbe08fe68  addrwatch.initd
7f490dd8109e0661e5955b3ebe892aa0e93fc62ae9627cf720de338e649ddd07f21bc470b6d038370568f4ed35bf7532967f72ca5cdf59a81a6403452da77a6e  addrwatch.confd
"
