Patch-Source: https://github.com/php/php-src/commit/ad5ee8a2b7ad960ba8286d11ff98d53098f72c97
From ad5ee8a2b7ad960ba8286d11ff98d53098f72c97 Mon Sep 17 00:00:00 2001
From: nielsdos <7771979+nielsdos@users.noreply.github.com>
Date: Mon, 19 Jun 2023 19:52:28 +0200
Subject: [PATCH] Revert changes to DOMAttr::$value and DOMAttr::$nodeValue
 expansion

Closes GH-11469.
---
 NEWS                                        |  2 +
 UPGRADING                                   |  4 --
 ext/dom/attr.c                              |  3 +-
 ext/dom/node.c                              |  3 --
 ext/dom/tests/DOMAttr_entity_expansion.phpt | 54 ---------------------
 5 files changed, 3 insertions(+), 63 deletions(-)
 delete mode 100644 ext/dom/tests/DOMAttr_entity_expansion.phpt

diff --git a/ext/dom/attr.c b/ext/dom/attr.c
index 417f92a25c36..0a558a766428 100644
--- a/ext/dom/attr.c
+++ b/ext/dom/attr.c
@@ -148,8 +148,7 @@ int dom_attr_value_write(dom_object *obj, zval *newval)
 	}
 
 	dom_remove_all_children((xmlNodePtr) attrp);
-	xmlNodePtr node = xmlNewTextLen((xmlChar *) ZSTR_VAL(str), ZSTR_LEN(str));
-	xmlAddChild((xmlNodePtr) attrp, node);
+	xmlNodeSetContentLen((xmlNodePtr) attrp, (xmlChar *) ZSTR_VAL(str), ZSTR_LEN(str));
 
 	zend_string_release_ex(str, 0);
 	return SUCCESS;
diff --git a/ext/dom/node.c b/ext/dom/node.c
index 29262f857914..7fb45efc3af3 100644
--- a/ext/dom/node.c
+++ b/ext/dom/node.c
@@ -178,9 +178,6 @@ int dom_node_node_value_write(dom_object *obj, zval *newval)
 	/* Access to Element node is implemented as a convenience method */
 	switch (nodep->type) {
 		case XML_ATTRIBUTE_NODE:
-			dom_remove_all_children(nodep);
-			xmlAddChild(nodep, xmlNewTextLen((xmlChar *) ZSTR_VAL(str), ZSTR_LEN(str)));
-			break;
 		case XML_ELEMENT_NODE:
 			dom_remove_all_children(nodep);
 			ZEND_FALLTHROUGH;
diff --git a/ext/dom/tests/DOMAttr_entity_expansion.phpt b/ext/dom/tests/DOMAttr_entity_expansion.phpt
deleted file mode 100644
index e3482d1a9d73..000000000000
--- a/ext/dom/tests/DOMAttr_entity_expansion.phpt
+++ /dev/null
@@ -1,54 +0,0 @@
---TEST--
-DOMAttr entity expansion
---EXTENSIONS--
-dom
---FILE--
-<?php
-$doc = new DOMDocument;
-$elt = $doc->createElement('elt');
-$doc->appendChild($elt);
-$elt->setAttribute('a','&');
-print $doc->saveXML($elt) . "\n";
-
-$attr = $elt->getAttributeNode('a');
-$attr->value = '&amp;';
-print "$attr->value\n";
-print $doc->saveXML($elt) . "\n";
-
-$attr->removeChild($attr->firstChild);
-print $doc->saveXML($elt) . "\n";
-
-$attr->nodeValue = '&';
-print "$attr->nodeValue\n";
-print $doc->saveXML($elt) . "\n";
-
-$attr->nodeValue = '&amp;';
-print "$attr->nodeValue\n";
-print $doc->saveXML($elt) . "\n";
-
-$elt->removeAttributeNode($attr);
-$elt->setAttributeNS('http://www.w3.org/2000/svg', 'svg:id','&amp;');
-print $doc->saveXML($elt) . "\n";
-
-$attr = $elt->getAttributeNodeNS('http://www.w3.org/2000/svg', 'id');
-$attr->value = '&lt;&amp;';
-print "$attr->value\n";
-print $doc->saveXML($elt) . "\n";
-
-$node = new DOMAttr('foo','bar');
-$node->nodeValue = 'xx&#x31;yy';
-print "$node->nodeValue\n";
-?>
---EXPECT--
-<elt a="&amp;"/>
-&amp;
-<elt a="&amp;amp;"/>
-<elt a=""/>
-&
-<elt a="&amp;"/>
-&amp;
-<elt a="&amp;amp;"/>
-<elt xmlns:svg="http://www.w3.org/2000/svg" svg:id="&amp;amp;"/>
-&lt;&amp;
-<elt xmlns:svg="http://www.w3.org/2000/svg" svg:id="&amp;lt;&amp;amp;"/>
-xx&#x31;yy
