Patch-Source: https://github.com/php/php-src/pull/15312/commits/f32be3b28047884eab5f1fd38b6fde83c286e57c
From f32be3b28047884eab5f1fd38b6fde83c286e57c Mon Sep 17 00:00:00 2001
From: "Christoph M. Becker" <cmbecker69@gmx.de>
Date: Fri, 9 Aug 2024 18:36:38 +0200
Subject: [PATCH] Support SHA256_Transform_shani() with MSVC, too

---
 ext/hash/hash_sha_ni.c  | 4 ++--
 ext/hash/php_hash_sha.h | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/ext/hash/hash_sha_ni.c b/ext/hash/hash_sha_ni.c
index 3c98786c73fd..f5784c296f6f 100644
--- a/ext/hash/hash_sha_ni.c
+++ b/ext/hash/hash_sha_ni.c
@@ -27,11 +27,11 @@
 #include "php_hash.h"
 #include "php_hash_sha.h"
 
-#if (defined(__i386__) || defined(__x86_64__)) && defined(HAVE_IMMINTRIN_H)
+#if defined(PHP_HASH_INTRIN_SHA_NATIVE) || defined(PHP_HASH_INTRIN_SHA_RESOLVER)
 
 # include <immintrin.h>
 
-# if PHP_HASH_INTRIN_SHA_RESOLVER
+# if defined(HAVE_FUNC_ATTRIBUTE_TARGET)
 static __m128i be32dec_128(const uint8_t * src)  __attribute__((target("ssse3")));
 void SHA256_Transform_shani(uint32_t state[PHP_STATIC_RESTRICT 8], const uint8_t block[PHP_STATIC_RESTRICT 64])  __attribute__((target("ssse3,sha")));
 # endif
diff --git a/ext/hash/php_hash_sha.h b/ext/hash/php_hash_sha.h
index d5282026b96a..c84a0eab08b2 100644
--- a/ext/hash/php_hash_sha.h
+++ b/ext/hash/php_hash_sha.h
@@ -56,10 +56,10 @@ PHP_HASH_API void PHP_SHA256Update(PHP_SHA256_CTX *, const unsigned char *, size
 void SHA256_Transform_sse2(uint32_t state[PHP_STATIC_RESTRICT 8], const uint8_t block[PHP_STATIC_RESTRICT 64], uint32_t W[PHP_STATIC_RESTRICT 64], uint32_t S[PHP_STATIC_RESTRICT 8]);
 #endif
 
-#if (defined(__i386__) || defined(__x86_64__)) && defined(HAVE_IMMINTRIN_H)
+#if ((defined(__i386__) || defined(__x86_64__)) && defined(HAVE_IMMINTRIN_H)) || ((defined(_M_X64) || defined(_M_IX86)) && defined(ZEND_INTRIN_SSSE3_RESOLVER))
 # if defined(__SSSE3__) && defined(__SHA__)
 #  define PHP_HASH_INTRIN_SHA_NATIVE 1
-# elif defined(HAVE_FUNC_ATTRIBUTE_TARGET)
+# elif defined(HAVE_FUNC_ATTRIBUTE_TARGET) || defined(_M_X64) || defined(_M_IX86)
 #  define PHP_HASH_INTRIN_SHA_RESOLVER 1
 # endif
 
