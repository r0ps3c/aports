# Automatically generated by apkbuild-cpan, template 4
# Contributor: Celeste <cielesti@protonmail.com>
# Maintainer: Celeste <cielesti@protonmail.com>
pkgname=perl-ev-hiredis
pkgver=0.07
pkgrel=0
#_pkgreal is used by apkbuild-cpan to find modules at MetaCpan
_pkgreal=EV-Hiredis
pkgdesc="Asynchronous redis client using hiredis and EV"
url="https://metacpan.org/release/EV-Hiredis/"
arch="all"
license="GPL-1.0-or-later OR Artistic-1.0-Perl"
depends="perl perl-ev"
makedepends="
	hiredis-dev perl-dev perl-file-which
	perl-module-build perl-module-build-xsutil
	"
checkdepends="perl-devel-refcount perl-test-deep perl-test-tcp"
subpackages="$pkgname-doc"
source="https://cpan.metacpan.org/authors/id/S/SH/SHOGO/EV-Hiredis-$pkgver.tar.gz
	use-system-hiredis.patch
	"
builddir="$srcdir/$_pkgreal-$pkgver"

# no perl-test-redisserver on 32-bit
case "$CARCH" in
armv7|armhf|x86)
	_test_args="--test_files=t/autoload.t"
	;;
*)
	checkdepends="$checkdepends perl-test-redisserver"
	;;
esac

prepare() {
	default_prepare

	# disable a very flaky test
	rm -v ./t/connect_unix.t
}

build() {
	export CFLAGS=$(perl -MConfig -E 'say $Config{ccflags}')
	perl Build.PL \
		--installdirs=vendor \
		--create_packlist=0
	./Build
}

check() {
	./Build test $_test_args
}

package() {
	./Build install --destdir="$pkgdir"
}

sha512sums="
58d4d6d69589155c0212cbc5169e6cc5552718daddcb713339ef84a5cd803c825ff6b10d6322d3e5c1556d018d9ef75de9261f925d3420a14efee05f0226ea87  EV-Hiredis-0.07.tar.gz
536157501fe64d127ff2d0084c03a2e8174f0aa4bc052c666624b26c79f68d6fe12493ae05daec469b5e36d96fd9704a66d90c2f40b922ff1a0b15519c794276  use-system-hiredis.patch
"
