# Contributor: Gavin Henry <ghenry@sentrypeer.org>
# Maintainer: Gavin Henry <ghenry@sentrypeer.org>
pkgname=opendht
pkgver=2.4.12
pkgrel=2
pkgdesc="C++17 Distributed Hash Table implementation"
url="https://github.com/savoirfairelinux/opendht"
arch="all"
license="GPL-3.0-or-later"
makedepends="
	argon2-dev
	asio-dev
	cmake
	cython
	fmt-dev
	gnutls-dev
	http-parser-dev
	jsoncpp-dev
	msgpack-cxx-dev
	nettle-dev
	py3-setuptools
	python3-dev
	readline-dev
	restinio-dev
	samurai
	"
subpackages="$pkgname-static py3-$pkgname:_py3 $pkgname-libs $pkgname-dev $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/savoirfairelinux/opendht/archive/refs/tags/v$pkgver.tar.gz
	msgpack-cxx.patch
	"

[ "$CARCH" = "riscv64" ] && options="$options textrels"

build() {
	if [ "$CBUILD" != "$CHOST" ]; then
		CMAKE_CROSSOPTS="-DCMAKE_SYSTEM_NAME=Linux -DCMAKE_HOST_SYSTEM_NAME=Linux"
	fi
	cmake -B build \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DOPENDHT_C=ON \
		-DOPENDHT_TOOLS=ON \
		-DOPENDHT_PYTHON=ON \
		-DOPENDHT_HTTP=ON \
		-DOPENDHT_PUSH_NOTIFICATIONS=ON \
		-G Ninja \
		$CMAKE_CROSSOPTS .
	cmake --build build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

libs() {
	default_libs
	amove usr/lib/libopendht-c.so
}

_py3() {
	pkgdesc="$pkgdesc (python bindings)"
	amove usr/lib/python*
	amove usr/bin/dhtcluster
}

sha512sums="
20186d6946765451d62429c403ef9ce3abee3fc1f95745ccd1d203ae06813468f0bdd2a79ae31f4007a0398ca2c3683ff71fba5b2b51d2fa77429f106061484b  opendht-2.4.12.tar.gz
ebfe058c97ea30c8f28d38546c3c6ee572435951a07b311198c719345f9c0de1ef4ad2a6e912b220a8b2f68a1d8a266a5df106bc314dd467c7b5fcae9d1fde05  msgpack-cxx.patch
"
