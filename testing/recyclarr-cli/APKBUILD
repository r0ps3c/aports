# Contributor: Fabricio Silva <hi@fabricio.dev>
# Maintainer: Fabricio Silva <hi@fabricio.dev>
pkgname=recyclarr-cli
pkgver=5.0.3
pkgrel=0
pkgdesc="Automatically sync TRaSH guides to your Sonarr and Radarr instances"
url="https://github.com/recyclarr/recyclarr"
arch="x86_64 aarch64 armv7"
license="MIT"
options="net !check !strip" # strip breaks the package
depends="
	dotnet7-runtime
	git
	"
makedepends="dotnet7-sdk"
source="
	$pkgname-$pkgver.tar.gz::https://github.com/recyclarr/recyclarr/archive/refs/tags/v$pkgver.tar.gz
	0001-disable-gitversion.patch
	"
builddir="$srcdir/recyclarr-$pkgver"

# map arch to dotnet
case $CARCH in
	x86_64) _dotnet_arch="x64" ;;
	aarch64) _dotnet_arch="arm64" ;;
	armv7) _dotnet_arch="arm" ;;
	*) _dotnet_arch="$CARCH" ;;
esac

prepare() {
	default_prepare

	# apply patch version
	sed -i "s/{Version}/v$pkgver-r$pkgrel.alpine/" src/Recyclarr.Cli/Program.cs
}

build() {
	# build the package and generate artifact
	dotnet publish src/Recyclarr.Cli \
		-p:RuntimeIdentifier="linux-musl-$_dotnet_arch" \
		-p:Configuration=Release \
		-p:SelfContained=false \
		-p:PublishSingleFile=true \
		-p:DisableGitVersionTask=true \
		--output publish
}

package() {
	install -Dm755 publish/recyclarr -t "$pkgdir"/usr/bin
}

sha512sums="
3415bd953fb2ec2ff8f3696fe6f1cb429c5c2181c65d4f0de9b756a6a7eb1472ccf186e78f6fa05dae6756e63410c0821f4bd7f10baac6baa9db643ec8fe763a  recyclarr-cli-5.0.3.tar.gz
eea996520ee18c202e5ca5a45fe9f32a6e19c4c0ee3df471ed5fdf3d1caa890a9d1d7de6ad428202aace40a13844a9569e324c71b3dc5b950b34f93eca4d6c72  0001-disable-gitversion.patch
"
