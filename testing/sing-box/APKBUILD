# Contributor: Anon <danilagdn.2004@gmail.com>
# Maintainer: Anon <danilagdn.2004@gmail.com>
pkgname=sing-box
pkgver=1.4.5
pkgrel=0
pkgdesc="The universal proxy platform."
url="https://sing-box.sagernet.org/"
arch="x86 x86_64"
license="GPL-3.0-or-later with name use or association addition"
makedepends="go"
subpackages="$pkgname-openrc"
options="!check"
source="$pkgname-$pkgver.tar.gz::https://github.com/SagerNet/sing-box/archive/v$pkgver.tar.gz
				$pkgname.initd"
_tags=with_gvisor,with_quic,with_wireguard,with_utls,with_reality_server,with_clash_api

build() {
	export CGO_CPPFLAGS="$CPPFLAGS"
	export CGO_CFLAGS="$CFLAGS"
	export CGO_CXXFLAGS="$CXXFLAGS"
	export CGO_LDFLAGS="$LDFLAGS"

	go build -v -trimpath -buildmode=pie -mod=readonly -modcacherw -tags "$_tags" \
	-ldflags "-X \"github.com/sagernet/sing-box/constant.Version=$pkgver\" -s -w
	-buildid= -linkmode=external" ./cmd/sing-box
}


package() {
	install -Dm644 LICENSE                      -t "$pkgdir/usr/share/licenses/$pkgname"
	install -Dm755 "$pkgname"                   -t "$pkgdir/usr/bin"
	install -Dm644 "release/config/config.json" -t "$pkgdir/etc/$pkgname"
	install -Dm755 "$srcdir/$pkgname.initd" 		"$pkgdir/etc/init.d/$pkgname"
}

sha512sums="
9a74cc1414470ead24d567e36f05ed4c941a25401a98813a5d9347bdf5b651d2b7a5dc0ec3da5c0b1de3174ebd87291ad20310803b8a8f666d7fcff49ff783ae  sing-box-1.4.5.tar.gz
b90e16319d2d2827886219e8f420954060c6e003a88f523595da5f04fe0530f95c3fae89f60dec452a87804f479164dd29b57f1329b928cc3d641fd7ef174284  sing-box.initd
"
