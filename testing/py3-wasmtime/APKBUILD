# Maintainer: psykose <alice@ayaya.dev>
pkgname=py3-wasmtime
pkgver=11.0.0
pkgrel=1
pkgdesc="Python WebAssembly runtime powered by Wasmtime"
url="https://github.com/bytecodealliance/wasmtime-py"
# wasmtime
arch="aarch64 x86_64"
license="Apache-2.0"
depends="libwasmtime"
makedepends="
	py3-gpep517
	py3-setuptools
	py3-wheel
	"
checkdepends="
	py3-cparser
	py3-flake8
	py3-mypy
	py3-pytest
	py3-pytest-flake8
	py3-pytest-mypy
	"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver.tar.gz::https://github.com/bytecodealliance/wasmtime-py/archive/refs/tags/$pkgver.tar.gz
	system-wasmtime.patch
	"
builddir="$srcdir/wasmtime-py-$pkgver"
options="!check" # FIXME: for some reason a random test abrts python

build() {
	PROD=1 \
	gpep517 build-wheel \
		--wheel-dir .dist \
		--output-fd 3 3>&1 >&2
}

check() {
	python3 -m venv --clear --without-pip --system-site-packages .testenv
	.testenv/bin/python3 -m installer .dist/*.whl
	.testenv/bin/python3 -m unittest discover tests
}

package() {
	python3 -m installer -d "$pkgdir" \
		.dist/*.whl
}

sha512sums="
d424972f50587a5362c4e577a31a2aa22d5e323b81a34b4f20d1ee3d5111b7cb1ec8481d4fb25921321053702de091a2e432f7e0b8ac16ba769862e45c123659  py3-wasmtime-11.0.0.tar.gz
c4794ee38b4283b62b549da14c276a13ad57e97468ab6f776ec24a661db6ad366d10d97c70dae3d135b9ef9852cc03ba325918dab188397e77a246969a2e0cc2  system-wasmtime.patch
"
