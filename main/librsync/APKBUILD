# Contributor: Jeremy Thomerson <jeremy@thomersonfamily.com>
# Maintainer: Jeremy Thomerson <jeremy@thomersonfamily.com>
pkgname=librsync
pkgver=2.3.3
pkgrel=0
pkgdesc="librsync implements the rolling-checksum algorithm of rsync"
url="https://github.com/librsync/librsync"
arch="all"
license="LGPL-2.1-or-later"
makedepends="
	bzip2-dev
	cmake
	perl
	popt-dev
	samurai
	zlib-dev
	"
subpackages="$pkgname-dev $pkgname-doc"
source="$pkgname-$pkgver.tar.gz::https://github.com/librsync/librsync/archive/v$pkgver.tar.gz
	"

case "$CARCH" in
s390x)
	# tests themselves assume little-endian
	options="$options !check"
	;;
esac

build() {
	CFLAGS="$CFLAGS -O2 -flto=auto" \
	CXXFLAGS="$CXXFLAGS -O2 -flto=auto" \
	cmake -B build -G Ninja \
		-DCMAKE_BUILD_TYPE=None \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DCMAKE_INSTALL_PREFIX=/usr
	cmake --build build
}

check() {
	cd build
	CTEST_OUTPUT_ON_FAILURE=TRUE ctest -j${JOBS:-2}
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
3a274d2219229134e0c8463824c04cbff6630d4b8a1cb5271acf655ba5d8983411702fb469a140b36716ddf5ed65afe6cee6efa6cd716bfa41f00f0092b47fc0  librsync-2.3.3.tar.gz
"
