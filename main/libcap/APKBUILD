# Contributor: Leo <thinkabit.ukim@gmail.com>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=libcap
pkgver=2.66
pkgrel=1
pkgdesc="POSIX 1003.1e capabilities"
arch="all"
license="BSD-3-Clause OR GPL-2.0-only"
url="https://sites.google.com/site/fullycapable/"
depends_dev="linux-headers"
makedepends_build="linux-headers perl bash"
makedepends_host="$depends_dev"
makedepends="$makedepends_build $makedepends_host"
subpackages="$pkgname-doc $pkgname-static $pkgname-dev $pkgname-utils libcap2"
source="https://kernel.org/pub/linux/libs/security/linux-privs/libcap2/libcap-$pkgver.tar.xz
	CVE-2023-2602.patch
	CVE-2023-2603.patch
	security-extra-1.patch
	security-extra-2.patch
	"

# secfixes:
#   2.66-r1:
#     - CVE-2023-2602
#     - CVE-2023-2603

build() {
	make BUILD_CC=gcc CC="${CC:-gcc}" lib=lib prefix=/usr GOLANG=no \
		DESTDIR="$pkgdir"
}

check() {
	make GOLANG=no test
}

package() {
	# backwards compatibility for things that depended on 'libcap'
	depends="libcap2=$pkgver-r$pkgrel $pkgname-utils=$pkgver-r$pkgrel"

	make lib=lib prefix=/usr GOLANG=no DESTDIR="$pkgdir" \
		install
}

utils() {
	pkgdesc="$pkgdesc (utils)"

	amove usr/sbin
}

libcap2() {
	replaces="$pkgname<2.64-r1"
	default_libs
}

sha512sums="
ac005b622f6e065f30ce282a5c87240e7b9da75366ee537aa4835bc501b44bc242c10a4ba4dc070e2415fc7f635d1c3c4e45fbeeaf962cf7973dda82bf6377f0  libcap-2.66.tar.xz
d78fbd06f0a7c1dbb1768b2e1c187e37a48631316261dc57d6042a704dd17fe6d3f66b94f4ccf13096dcc31c5be7e9e26a11fcec179c1de550d3a4648ed43c0c  CVE-2023-2602.patch
9e204a233a584881f6c69fd5f2dee268a959386ee0e94183bfad08963c8138f86a68243e292f11d91d7c3da1db5cbb60d572709bc51fa7be1d15b272cd71e3be  CVE-2023-2603.patch
bf0a6d97063ece97645ef02bc5f58dd5b096c5a1669b580728d7822a51d8febc43ede6e493896eefb7e56207eaaf6a531ed85b991689dddb6a32103172df8368  security-extra-1.patch
2d910b93b408fd8dc55792302c409b891cd7de6c42fa1b7c6bc551ca9f7153a85052e1ad24cd2968ba2bef5a99d1bd629ad831ba9714e9f3eeeac887a4df6139  security-extra-2.patch
"
