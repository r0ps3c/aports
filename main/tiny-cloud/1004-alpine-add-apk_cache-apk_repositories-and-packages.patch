From 1b4d27eb03b0e32bec6fecaa97afbeda55509d1a Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 8 May 2023 20:17:06 +0200
Subject: [PATCH 1004/1006] alpine: add apk_cache, apk_repositories and
 packages

So we can configure apk cache, repositories and install packages from
user-data.
---
 lib/tiny-cloud/cloud/alpine/init       |  8 ++-
 lib/tiny-cloud/user-data/alpine-config | 63 ++++++++++++++++++
 tests/tiny-cloud-alpine.test           | 90 +++++++++++++++++++++++++-
 3 files changed, 158 insertions(+), 3 deletions(-)

diff --git a/lib/tiny-cloud/cloud/alpine/init b/lib/tiny-cloud/cloud/alpine/init
index badaec9..dad1df7 100644
--- a/lib/tiny-cloud/cloud/alpine/init
+++ b/lib/tiny-cloud/cloud/alpine/init
@@ -27,8 +27,12 @@ insert_after() {
 }
 
 INIT_ACTIONS_EARLY="$(replace_word set_default_interfaces set_network_interfaces $INIT_ACTIONS_EARLY)"
-INIT_ACTIONS_MAIN="$(insert_after save_userdata load_userdata_handler $INIT_ACTIONS_MAIN)"
-INIT_ACTIONS_MAIN="$(insert_after set_hostname userdata_ntp $INIT_ACTIONS_MAIN)"
+INIT_ACTIONS_MAIN="$(insert_after save_userdata \
+    load_userdata_handler \
+    $INIT_ACTIONS_MAIN)"
+INIT_ACTIONS_MAIN="$(insert_after set_hostname \
+    "userdata_ntp userdata_apk_cache userdata_apk_repositories userdata_packages" \
+    $INIT_ACTIONS_MAIN)"
 
 add_once() {
     local file="$1"
diff --git a/lib/tiny-cloud/user-data/alpine-config b/lib/tiny-cloud/user-data/alpine-config
index bddc9bb..1140366 100644
--- a/lib/tiny-cloud/user-data/alpine-config
+++ b/lib/tiny-cloud/user-data/alpine-config
@@ -29,3 +29,66 @@ init__userdata_ntp() {
         $MOCK rc-service "$svc" start
     fi
 }
+
+init__userdata_apk_cache() {
+    local cache="$(imds user-data/apk/cache)"
+    if [ -z "$cache" ]; then
+        return
+    fi
+    mkdir -p "$ROOT/$cache"
+    # make link relative
+    case "$cache" in
+        /*) cache="../..$cache";;
+    esac
+    mkdir -p "$ROOT"/etc/apk
+    ln -sf "$cache" "$ROOT"/etc/apk/cache
+}
+
+init__userdata_apk_cache() {
+    local cache="$(imds user-data/apk/cache)"
+    if [ -z "$cache" ]; then
+        return
+    fi
+    mkdir -p "$ROOT/$cache"
+    # make link relative
+    case "$cache" in
+        /*) cache="../..$cache";;
+    esac
+    mkdir -p "$ROOT"/etc/apk
+    ln -sf "$cache" "$ROOT"/etc/apk/cache
+}
+
+init__userdata_apk_repositories() {
+    local repositories="$(imds user-data/apk/repositories)"
+    mkdir -p "$ROOT"/etc/apk
+    for r in $repositories; do
+        local baseurl="$(imds user-data/apk/repositories/$r/base_url)"
+        local repos="$(imds user-data/apk/repositories/$r/repos)"
+        local version="$(imds user-data/apk/repositories/$r/version)"
+        if [ -z "$version" ]; then
+            local version_id=$( . "$ROOT"/etc/os-release 2>/dev/null && echo "$VERSION_ID")
+            case "$version_id" in
+                edge*|*_alpha*) version="edge";;
+                [0-9]*.[0-9]*.[0-9]*) version="v${version_id%.*}";;
+            esac
+        fi
+        if [ -n "$version" ] && [ "$version" != "." ] && [ "$version" != "/" ]; then
+            baseurl="${baseurl%/}/$version"
+        fi
+        for repo in $repos; do
+            local uri="${baseurl%/}/$(imds user-data/apk/repositories/$r/repos/$repo)"
+            add_once "$ROOT"/etc/apk/repositories "$uri"
+        done
+    done
+}
+
+init__userdata_packages() {
+    local packages="$(imds user-data/packages)"
+    local pkgs=
+    for i in $packages; do
+        pkgs="$pkgs $(imds user-data/packages/$i)"
+    done
+    if [ -n "$pkgs" ]; then
+        $MOCK apk add $pkgs
+    fi
+}
diff --git a/tests/tiny-cloud-alpine.test b/tests/tiny-cloud-alpine.test
index b8e3688..78705a7 100755
--- a/tests/tiny-cloud-alpine.test
+++ b/tests/tiny-cloud-alpine.test
@@ -11,7 +11,13 @@ init_tests \
 	set_network_config_network_interfaces \
 	userdata_ntp \
 	userdata_ntp_busybox \
-	userdata_ntp_openntpd
+	userdata_ntp_openntpd \
+	userdata_apk_cache \
+	userdata_apk_repositories \
+	userdata_apk_repositories_version \
+	userdata_apk_repositories_version_auto_edge \
+	userdata_packages
+
 
 set_network_config_network_interfaces_body() {
 	fake_metadata_nocloud <<-EOF
@@ -86,3 +92,85 @@ userdata_ntp_openntpd_body() {
 		-o match:"rc-service .*openntpd" \
 		tiny-cloud main
 }
+
+userdata_apk_cache_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		apk:
+		  cache: /var/cache/apk
+	EOF
+	atf_check \
+		-e match:"userdata_apk_cache .*DONE" \
+		-o ignore \
+		tiny-cloud main
+	atf_check -o match:"$PWD/var/cache/apk" readlink -f etc/apk/cache
+}
+
+userdata_apk_repositories_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		apk:
+		  repositories:
+		    - base_url: /srv/packages
+		      repos: [ "main", "community" ]
+	EOF
+	atf_check \
+		-e match:"userdata_apk_repositories .*DONE" \
+		-o ignore \
+		tiny-cloud main
+	atf_check -o match:"^/srv/packages/main$" \
+		-o match:"^/srv/packages/community$" \
+		cat etc/apk/repositories
+}
+
+userdata_apk_repositories_version_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		apk:
+		  repositories:
+		    - base_url: https://cdn.alpinelinux.org/
+		      version: edge
+		      repos: [ "main", "community" ]
+	EOF
+	atf_check \
+		-e match:"userdata_apk_repositories .*DONE" \
+		-o ignore \
+		tiny-cloud main
+	atf_check -o match:"^https://cdn.alpinelinux.org/edge/main$" \
+		-o match:"^https://cdn.alpinelinux.org/edge/community$" \
+		cat etc/apk/repositories
+}
+
+userdata_apk_repositories_version_auto_edge_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		apk:
+		  repositories:
+		    - base_url: https://cdn.alpinelinux.org/
+		      repos: [ "main", "community" ]
+	EOF
+	mkdir -p etc
+	echo "VERSION_ID=3.18_alpha20230329" > etc/os-release
+
+	atf_check \
+		-e match:"userdata_apk_repositories .*DONE" \
+		-o ignore \
+		tiny-cloud main
+	atf_check -o match:"^https://cdn.alpinelinux.org/edge/main$" \
+		-o match:"^https://cdn.alpinelinux.org/edge/community$" \
+		cat etc/apk/repositories
+}
+
+userdata_packages_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		packages:
+		  - tmux
+		  - vim
+	EOF
+	atf_check \
+		-e match:"userdata_packages .*DONE" \
+		-o match:"apk add .*tmux" \
+		-o match:"apk add .*vim" \
+		tiny-cloud main
+}
-- 
2.40.1

