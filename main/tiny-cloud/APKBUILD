# Contributor: Mike Crute <mike@crute.us>
# Contributor: Jake Buchholz Göktürk <tomalok@gmail.com>
# Maintainer: Jake Buchholz Göktürk <tomalok@gmail.com>
pkgname=tiny-cloud
pkgver=3.0.0_rc1
pkgrel=4
pkgdesc="Tiny Cloud instance bootstrapper"
url="https://gitlab.alpinelinux.org/alpine/cloud/tiny-cloud"
arch="noarch"
license="MIT"
checkdepends="kyua xz lz4 zstd"
depends="e2fsprogs-extra partx sfdisk yx openssh-server"
install="$pkgname.pre-upgrade"
source="
	$url/-/archive/$pkgver/$pkgname-$pkgver.tar.gz

	0001-tiny-cloud-Print-usage-on-invalid-option-and-add-tes.patch
	0002-Only-try-to-expand-root-which-is-ext4.patch
	0003-Set-Default-interfaces.patch
	0004-Add-create_default_user-Init-Action.patch
	0005-Enable-sshd-Source-UserData-Handler.patch
	0006-Make-init__create_default_user-return-success.patch
	0007-Make-it-posible-to-override-the-init-actions.patch
	0008-Don-t-print-error-on-missing-proc-mounts.patch
	0009-tests-unify-fake_metadata_nocloud-and-fake_userdata_.patch
	0010-Add-test-for-empty-or-no-config.patch
	0011-Avoid-set-empty-hostname.patch
	0012-Handle-error-when-setting-ssh-key.patch

	1001-alpine-add-meta-data-network-interfaces-and-resolv_c.patch
	1002-Load-user-data-handler-from-function-so-we-can-acces.patch
	1003-alpine-add-user-data-ntp.patch
	1004-alpine-add-apk_cache-apk_repositories-and-packages.patch
	1005-alpine-add-bootcmd-and-runcmd.patch
	1006-Install-alpine-provider.patch

	$pkgname-aws.post-install
	$pkgname-azure.post-install
	$pkgname-gcp.post-install
	$pkgname-nocloud.post-install
	$pkgname-oci.post-install
	$pkgname-openrc.pre-upgrade
	$pkgname.pre-upgrade
"
subpackages="
	$pkgname-network
	$pkgname-openrc
	$pkgname-alpine
	$pkgname-aws
	$pkgname-azure
	$pkgname-gcp
	$pkgname-oci
	$pkgname-nocloud
"

check() {
	make check
}

package() {
	make PREFIX="$pkgdir" core openrc
}

openrc() {
	install="$pkgname-openrc.pre-upgrade"
	default_openrc
}

network() {
	pkgdesc="Tiny Cloud - networking module"
	depends="ifupdown-ng iproute2-minimal $pkgname=$pkgver-r$pkgrel"
	make -C "$builddir" PREFIX="$subpkgdir" network
}

alpine() {
	pkgdesc="Tiny Cloud - Alpine installer module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-alpine.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" alpine
}

aws() {
	pkgdesc="Tiny Cloud - Amazon Web Services module"
	depends="nvme-cli $pkgname-network=$pkgver-r$pkgrel"
	provides="tiny-ec2-bootstrap"
	install="$pkgname-aws.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" aws
}

azure() {
	pkgdesc="Tiny Cloud - Azure module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-azure.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" azure
}

gcp() {
	pkgdesc="Tiny Cloud - Google Cloud Platform module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-gcp.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" gcp
}

oci() {
	pkgdesc="Tiny Cloud - Oracle Cloud Infrastructure module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-oci.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" oci
}

nocloud() {
	pkgdesc="Tiny Cloud - NoCloud module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-nocloud.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" nocloud
}

sha512sums="
f111853f4e6877c5a5775e5ecbbdef1823150c8a7c5180e18030d8d17529bd848b1893dd469700a29a07f5a97e42e0b7d5909817e0440278879d2df05e019a86  tiny-cloud-3.0.0_rc1.tar.gz
a8a41074d4b0a7a5036eefc8b7e2cf1989fb73aaed1d3d3fe772b1fbe2c199665d3e1cb76a6daa2fce3747957986a24c9a2bf2bcef5ed098b840d6ade5305ff4  0001-tiny-cloud-Print-usage-on-invalid-option-and-add-tes.patch
c5c31caa2ac186ef1add0f29e67d2d85f34cfed6aa80ebdd00c1011cc1a0d99e335f9d0ff14288c49627c352e042d4330d71ca86c9d95099cb328985c8c26370  0002-Only-try-to-expand-root-which-is-ext4.patch
9fbd07e35f47b7e33c0f341d1993909703c52b0a2e2151afca9ed283cb6daf9c67a6fabb7831a3c74ad31197d9eec957bafe842618db8983bf24fda90e4ea308  0003-Set-Default-interfaces.patch
861e0dcd3f94582913cf0587695940e3f34cddc49e53449a91899e9c4dad2c17a358b41d061afacee3842b60da43d65cbf5f63141fc9ef2557ae5fe1501a6e68  0004-Add-create_default_user-Init-Action.patch
f8265ed76cfc58b9cc69f425ae11c680055287468d1b1a6418dc0a5116333c96dca5d42a777a9020ec604ccbbb61210505d3e863a89a5f24082e87845e60bdee  0005-Enable-sshd-Source-UserData-Handler.patch
6d2e7e78a35f57a8189f3c2a4343f01a8825f4857f05c57bd39834398058fc3cff8cab165d80ae60e8ce68e325904c6e138d03188900e6e71e7fc88ef5e9b522  0006-Make-init__create_default_user-return-success.patch
f116fe224463315bdeba3b3a29ff2717c4900b3bfd5aed6ad8b8ee6540ade0ae85bd13b4e1325469018013712d647f1f0185bf0788c9383f8e09d70756cd5641  0007-Make-it-posible-to-override-the-init-actions.patch
8450846162398a2820f8e660b479c2beea02866e492edc27f500310752f6209192cd435a63369ad09b990f201843116d1f29df6d7cbe9b30486b330ddfee0e00  0008-Don-t-print-error-on-missing-proc-mounts.patch
24a356d22fb9a85fc4a15f4cf1cc15d8fd25cb5fc1e3bb149a866f06c402074ce0ea64739afb6726fbf7357090e45328e8c2514169c569d1195648cc1c7b63e1  0009-tests-unify-fake_metadata_nocloud-and-fake_userdata_.patch
d48ad3249eb0b3460c2242103e654dc329d522a2c889c448ddffb0babc692b0f2178289cdd1dbe6042fd6edcfaf94787cffbb31f99afd1ec6d33ab10fe17feed  0010-Add-test-for-empty-or-no-config.patch
f5a45bd6cca02e53754ff90894a93db84019a785617077f88b15ae7b0ad9500ed3bc77656e67b011511d55264724fb3f0d29299138caeb869cb7ed0775968490  0011-Avoid-set-empty-hostname.patch
35a5f812fcbf9159ddb8a0d0d22b7b03fbcec2f4c2604c564a9c81a96c143d93f0f39818952131a8cb4520e22c1972077d385d0a06981da5a0f1e04e260b23c2  0012-Handle-error-when-setting-ssh-key.patch
ddbd1cb5225fcc225f590ee4dc7ee0257f02480a8c31e2e29eaa56947c7e9fc78c3dee52bf1494be0978e9564fcae751579b00f7bff70d7f357dbbb92f258ce9  1001-alpine-add-meta-data-network-interfaces-and-resolv_c.patch
ca48783bd286bbc495199043dcf313ef130dca9e27d60773e2b2380d395f431dcc251ff58b41a6739f8e113991c5756b8baaded9d0242bc78d6fadf00c8c19e7  1002-Load-user-data-handler-from-function-so-we-can-acces.patch
d67551df6221541068eed5543767cacc5f0f91d729783d1242268cd19bb66287e3d0000266202f35df015217d4f938b13210dd42b5986c459023a18b2b48c510  1003-alpine-add-user-data-ntp.patch
9cee2fe78bb3353fe97211ba7818403f8c78a0bbe9526826963eb6781fe2f282db500d0343d20bfa8cb4c0b1c9f09516dc92a8a2ed5f2286a9c449c110779609  1004-alpine-add-apk_cache-apk_repositories-and-packages.patch
70b7755ae81193302a39aa60c2b3f90aa45ee10bb1a92d2574696826ee489aca5349d49c308eadf8ddf9b8763b6aab92c8845ae8fbc2a9e2df7ade116309fd71  1005-alpine-add-bootcmd-and-runcmd.patch
5a0d2d3390639867181da92624daa4205ef59462c6f2b9362f29dae804e1c41d46db2fbcdaa511c9a0ab43da53e57352cd361bcc174711b5ce540474788ea248  1006-Install-alpine-provider.patch
917ba6c5eaad4fb0670023adb28a5e7666f0f76c03c4091ca7fe71e63cdc2556889755f75069dd7046ccdf511ceb3665e6fc1a796ec137027f9189d58428361b  tiny-cloud-aws.post-install
04752ec96f25dd5ceb7d8b7c63ac0e9f8f92fea675d115c24f0bebaa4cb16af147550f9d4c148e800273389da2c64e6304dc45333e25ae08d9aa4e33aff431c9  tiny-cloud-azure.post-install
05b7ccbb441f7635b13b1c81e8341e74cbf6cd158b257c9286d31ca736c45ef64ef2778990f57b3f880372b442e0a677e95a0fbe2ec357e89627363707089a7c  tiny-cloud-gcp.post-install
df4f37aa7c27d7f011ef2aa6e3c1d88d25c9e117df947bd238c1fc3aa9aef9e9d66af679bb9e2c58564cbc8fb5a1ec51827063a91c0a8cb4efc1a7563cc5a172  tiny-cloud-nocloud.post-install
e23482f9b6678a34c1ea98a55c76852e571f0c86717b26e449687e1691d4f00608a16e3f2a6119ee7d793c6853a3c4d4eac2e82a075ab0456d9f94f2e1110030  tiny-cloud-oci.post-install
10ac6796d37e9500eed38958c0cdbcbc3886af62a8e0f404fd69464fa7b3b6eb91d734d41632baaf3525a6d1002ebc4ed9591c39ba7dd9757b3258fce6047ee4  tiny-cloud-openrc.pre-upgrade
83217a30e495bcc18ad1a5d744806d499b5bdf929df3f18597216a25f465e5d4764ca66499d221bf5738b83639f1ec80de2a14e4b64aac80d51b285c01f0fc74  tiny-cloud.pre-upgrade
"
