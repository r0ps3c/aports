# Contributor: Mike Crute <mike@crute.us>
# Contributor: Jake Buchholz Göktürk <tomalok@gmail.com>
# Maintainer: Jake Buchholz Göktürk <tomalok@gmail.com>
pkgname=tiny-cloud
pkgver=3.0.0_rc1
pkgrel=2
pkgdesc="Tiny Cloud instance bootstrapper"
url="https://gitlab.alpinelinux.org/alpine/cloud/tiny-cloud"
arch="noarch"
license="MIT"
checkdepends="kyua xz lz4 zstd"
depends="e2fsprogs-extra partx sfdisk yx openssh-server"
install="$pkgname.pre-upgrade"
source="
	$url/-/archive/$pkgver/$pkgname-$pkgver.tar.gz

	0001-Only-try-to-expand-root-which-is-ext4.patch

	0001-Configure-network-in-early-phase.patch
	0002-Auto-configure-network-interfaces-for-nocloud.patch
	0003-tests-unify-fake_metadata_nocloud-and-fake_userdata_.patch
	0004-nocloud-add-meta-data-network-interfaces-and-resolv_.patch
	0005-Create-cloud-user-if-its-missing-and-configure-doas.patch
	0006-Add-support-for-user-data-ntp.patch
	0007-Add-support-for-userdata-apk-packages.patch
	0008-Add-user-data-bootcmd-and-runcmd.patch
	0009-Ensure-sshd-service-is-enabled.patch

	$pkgname-aws.post-install
	$pkgname-azure.post-install
	$pkgname-gcp.post-install
	$pkgname-nocloud.post-install
	$pkgname-oci.post-install
	$pkgname-openrc.pre-upgrade
	$pkgname.pre-upgrade
"
subpackages="
	$pkgname-network
	$pkgname-openrc
	$pkgname-aws
	$pkgname-azure
	$pkgname-gcp
	$pkgname-oci
	$pkgname-nocloud
"

check() {
	make check
}

package() {
	make PREFIX="$pkgdir" core openrc
}

openrc() {
	install="$pkgname-openrc.pre-upgrade"
	default_openrc
}

network() {
	pkgdesc="Tiny Cloud - networking module"
	depends="ifupdown-ng iproute2-minimal $pkgname=$pkgver-r$pkgrel"
	make -C "$builddir" PREFIX="$subpkgdir" network
}

aws() {
	pkgdesc="Tiny Cloud - Amazon Web Services module"
	depends="nvme-cli $pkgname-network=$pkgver-r$pkgrel"
	provides="tiny-ec2-bootstrap"
	install="$pkgname-aws.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" aws
}

azure() {
	pkgdesc="Tiny Cloud - Azure module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-azure.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" azure
}

gcp() {
	pkgdesc="Tiny Cloud - Google Cloud Platform module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-gcp.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" gcp
}

oci() {
	pkgdesc="Tiny Cloud - Oracle Cloud Infrastructure module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-oci.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" oci
}

nocloud() {
	pkgdesc="Tiny Cloud - NoCloud module"
	depends="$pkgname=$pkgver-r$pkgrel"
	install="$pkgname-nocloud.post-install"
	make -C "$builddir" PREFIX="$subpkgdir" nocloud
}

sha512sums="
f111853f4e6877c5a5775e5ecbbdef1823150c8a7c5180e18030d8d17529bd848b1893dd469700a29a07f5a97e42e0b7d5909817e0440278879d2df05e019a86  tiny-cloud-3.0.0_rc1.tar.gz
c175cf30134bf31fc905296803edd2738bea293d0714de50ccbf45b043b1ee139276bd7397e922ccf94d6301718b9e96a84dc8bbf6c99eda4b55c09f6aba62f2  0001-Only-try-to-expand-root-which-is-ext4.patch
22ed1ecc1bd1401db2d4990409dbbb10c24ce3ed084cd09f0be45e309c401ab645945bb1d8d3c971f989ba9e01b913e7cfa759b8a0d2b169d3b56cd495ca03b2  0001-Configure-network-in-early-phase.patch
0c795237b2978428ba9e3dd27a5fd801fb5a70831cc19e481fd442436df879584205d7d297a8e50d859cbeff09468352c63212c2e3ad8a7cb567b8edf37ddb61  0002-Auto-configure-network-interfaces-for-nocloud.patch
59dbde696579f45ad1caac93b32940c244902488a15f368a85b6c73b6a5b9877d606d7a4cfaceb4038276d15acc8defca96a2545b310a1481b09bd29f827858f  0003-tests-unify-fake_metadata_nocloud-and-fake_userdata_.patch
a9d0b246e67e83ce01a2bcb0f0bc8f10d680a81ab73e996ee386d396d37cdfbc6a0b4e12eb2063f36e77b4e12b4e0498b533dbe52e94fd0e1df0cd4555b768ed  0004-nocloud-add-meta-data-network-interfaces-and-resolv_.patch
92d2e3c7860ac06847ca2164c0ba9aaec5dd8bff27af63e9909fb08878406fb30ebdcf7fe2892602337d89371c25beb53e4d3f77c134d7bb5cc345218eb9ab57  0005-Create-cloud-user-if-its-missing-and-configure-doas.patch
14d40003e2f208437ab3734f232df2a2292621a3dbcb903494cbeead892f14ccba48215617a2d96b557ca8e3bb63bb5335172f1cdb4a800dd5ce588004915f80  0006-Add-support-for-user-data-ntp.patch
b5b0e15163b0999eb0bb3f7dd4846c8364a1f290a82742eac708ade18dd3ade90def7e01c454349ccfa12674868ea13c85b8877adcf808b80d5b3a934d9bf551  0007-Add-support-for-userdata-apk-packages.patch
b7c1f3c40907de0548a86449fc9823872e2d08dd56f37609248ff0000022a0f0a089ee10065ffda21bb17dde3c90fac58f8488dcf00bff2ab44a34056fee01ab  0008-Add-user-data-bootcmd-and-runcmd.patch
1df308733d4ca493ccb341888274c494ccda51ef3252351d3cf9949d35453290b81e877d42c0f086ab1e878c7c15d01e88acd0882337b5fe4b6d2e9392b2ecc2  0009-Ensure-sshd-service-is-enabled.patch
917ba6c5eaad4fb0670023adb28a5e7666f0f76c03c4091ca7fe71e63cdc2556889755f75069dd7046ccdf511ceb3665e6fc1a796ec137027f9189d58428361b  tiny-cloud-aws.post-install
04752ec96f25dd5ceb7d8b7c63ac0e9f8f92fea675d115c24f0bebaa4cb16af147550f9d4c148e800273389da2c64e6304dc45333e25ae08d9aa4e33aff431c9  tiny-cloud-azure.post-install
05b7ccbb441f7635b13b1c81e8341e74cbf6cd158b257c9286d31ca736c45ef64ef2778990f57b3f880372b442e0a677e95a0fbe2ec357e89627363707089a7c  tiny-cloud-gcp.post-install
df4f37aa7c27d7f011ef2aa6e3c1d88d25c9e117df947bd238c1fc3aa9aef9e9d66af679bb9e2c58564cbc8fb5a1ec51827063a91c0a8cb4efc1a7563cc5a172  tiny-cloud-nocloud.post-install
e23482f9b6678a34c1ea98a55c76852e571f0c86717b26e449687e1691d4f00608a16e3f2a6119ee7d793c6853a3c4d4eac2e82a075ab0456d9f94f2e1110030  tiny-cloud-oci.post-install
10ac6796d37e9500eed38958c0cdbcbc3886af62a8e0f404fd69464fa7b3b6eb91d734d41632baaf3525a6d1002ebc4ed9591c39ba7dd9757b3258fce6047ee4  tiny-cloud-openrc.pre-upgrade
83217a30e495bcc18ad1a5d744806d499b5bdf929df3f18597216a25f465e5d4764ca66499d221bf5738b83639f1ec80de2a14e4b64aac80d51b285c01f0fc74  tiny-cloud.pre-upgrade
"
