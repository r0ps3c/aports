From f3f8ad564c441802f7f79b906228fde6c5007469 Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Thu, 4 May 2023 16:21:33 +0200
Subject: [PATCH 8/9] Add user-data bootcmd and runcmd

boocmd runs as early as possible, while runcmd runs late, during final.
---
 lib/tiny-cloud/init   | 19 +++++++++++++++++++
 tests/init-final.test | 14 +++++++++++++-
 tests/init-main.test  | 12 ++++++++++++
 3 files changed, 44 insertions(+), 1 deletion(-)

diff --git a/lib/tiny-cloud/init b/lib/tiny-cloud/init
index c655e27..42931bb 100644
--- a/lib/tiny-cloud/init
+++ b/lib/tiny-cloud/init
@@ -19,6 +19,7 @@ INIT_ACTIONS_EARLY="
 INIT_ACTIONS_MAIN="
     save_userdata
     set_hostname
+    userdata_bootcmd
     userdata_ntp
     userdata_apk_cache
     userdata_apk_repositories
@@ -26,6 +27,7 @@ INIT_ACTIONS_MAIN="
     set_ssh_keys
 "
 INIT_ACTIONS_FINAL="
+    userdata_runcmd
     run_userdata
 "
 
@@ -154,6 +156,15 @@ init__save_userdata() {
     rm "$tmpfile"
 }
 
+init__userdata_bootcmd() {
+    # run bootcmd
+    local bootcmds="$(get_userdata bootcmd)"
+    for i in $bootcmds; do
+        local cmd="$(get_userdata bootcmd "$i")"
+        sh -c "$cmd"
+    done
+}
+
 init__userdata_ntp() {
     local ntp_enabled="$(get_userdata ntp enabled)"
     if [ "$ntp_enabled" != "yes" ] && [ "$ntp_enabled" != "true" ]; then
@@ -251,6 +262,14 @@ init__run_userdata() {
     return $(cat "$exit")
 }
 
+init__userdata_runcmd() {
+	local runcmds="$(get_userdata runcmd)"
+	for i in $runcmds; do
+		local cmd="$(get_userdata runcmd $i)"
+		sh -c "$cmd"
+	done
+}
+
 ### potentially override the above, per cloud
 
 # load cloud-specific init functions / vars
diff --git a/tests/init-final.test b/tests/init-final.test
index 2360965..6d6dab7 100755
--- a/tests/init-final.test
+++ b/tests/init-final.test
@@ -9,7 +9,8 @@ PROVIDERS="aws azure gcp nocloud oci"
 
 init_tests \
 	userdata_type \
-	run_userdata
+	run_userdata \
+	userdata_runcmd
 
 
 userdata_type_body() {
@@ -45,3 +46,14 @@ run_userdata_body() {
 	grep "hello from user-data" var/log/user-data.log || atf_fail "user-data.log failed"
 	grep -w "0" var/log/user-data.exit || atf_fail "user-data.exit failed"
 }
+
+userdata_runcmd_body() {
+	fake_userdata_nocloud <<-EOF
+		runcmd:
+		  - echo foo
+		  - echo bar
+	EOF
+	CLOUD=nocloud atf_check \
+		-o match:"^foo$" -o match:"^bar$" \
+		sh -c ". \"$lib\"; init__userdata_runcmd"
+}
diff --git a/tests/init-main.test b/tests/init-main.test
index 68bf897..c7658fd 100755
--- a/tests/init-main.test
+++ b/tests/init-main.test
@@ -11,6 +11,7 @@ init_tests \
 	set_ssh_keys \
 	save_userdata_plain \
 	save_userdata_compressed \
+	userdata_bootcmd \
 	userdata_ntp \
 	userdata_ntp_busybox \
 	userdata_ntp_openntpd \
@@ -96,6 +97,17 @@ save_userdata_compressed_body() {
 	done
 }
 
+userdata_bootcmd_body() {
+	fake_userdata_nocloud <<-EOF
+		bootcmd:
+		  - echo foo
+		  - echo bar
+	EOF
+	CLOUD=nocloud atf_check \
+		-o match:"^foo$" -o match:"^bar$" \
+		sh -c ". \"$lib\"; init__userdata_bootcmd"
+}
+
 userdata_ntp_body() {
 	fake_userdata_nocloud <<-EOF
 		ntp:
-- 
2.40.1

