From 582d8944989ccc3d7dd2dc0c95b305b9ff3b025d Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Mon, 8 May 2023 17:31:08 +0200
Subject: [PATCH 1003/1006] alpine: add user-data ntp

This needs to happen early so time is right for https later
---
 lib/tiny-cloud/cloud/alpine/init       |  2 +-
 lib/tiny-cloud/user-data/alpine-config | 31 ++++++++++++++++
 tests/tiny-cloud-alpine.test           | 49 +++++++++++++++++++++++++-
 3 files changed, 80 insertions(+), 2 deletions(-)
 create mode 100644 lib/tiny-cloud/user-data/alpine-config

diff --git a/lib/tiny-cloud/cloud/alpine/init b/lib/tiny-cloud/cloud/alpine/init
index b146b6c..badaec9 100644
--- a/lib/tiny-cloud/cloud/alpine/init
+++ b/lib/tiny-cloud/cloud/alpine/init
@@ -28,6 +28,7 @@ insert_after() {
 
 INIT_ACTIONS_EARLY="$(replace_word set_default_interfaces set_network_interfaces $INIT_ACTIONS_EARLY)"
 INIT_ACTIONS_MAIN="$(insert_after save_userdata load_userdata_handler $INIT_ACTIONS_MAIN)"
+INIT_ACTIONS_MAIN="$(insert_after set_hostname userdata_ntp $INIT_ACTIONS_MAIN)"
 
 add_once() {
     local file="$1"
@@ -65,4 +66,3 @@ init__set_network_interfaces() {
 init__load_userdata_handler() {
     load_userdata_handler
 }
-
diff --git a/lib/tiny-cloud/user-data/alpine-config b/lib/tiny-cloud/user-data/alpine-config
new file mode 100644
index 0000000..bddc9bb
--- /dev/null
+++ b/lib/tiny-cloud/user-data/alpine-config
@@ -0,0 +1,31 @@
+# Script UserData Functions
+# vim:set ts=4 et ft=sh:
+
+init__userdata_ntp() {
+    local ntp_enabled="$(imds user-data/ntp/enabled)"
+    if [ "$ntp_enabled" != "yes" ] && [ "$ntp_enabled" != "true" ]; then
+        return
+    fi
+    local ntp_client="$(imds user-data/ntp/ntp_client)"
+    local svc= pkg=
+    case "$ntp_client" in
+        busybox)
+            svc=ntpd
+            ;;
+        chrony|"")
+            pkg=chrony
+            svc=chronyd
+            ;;
+        openntpd)
+            pkg=openntpd
+            svc=openntpd
+            ;;
+    esac
+    if [ -n "$pkg" ]; then
+        $MOCK apk add "$pkg"
+    fi
+    if [ -n "$svc" ]; then
+        $MOCK rc-update add "$svc" default
+        $MOCK rc-service "$svc" start
+    fi
+}
diff --git a/tests/tiny-cloud-alpine.test b/tests/tiny-cloud-alpine.test
index ba98448..b8e3688 100755
--- a/tests/tiny-cloud-alpine.test
+++ b/tests/tiny-cloud-alpine.test
@@ -8,7 +8,10 @@ export CLOUD=alpine
 lib="$srcdir"/lib/tiny-cloud/cloud/alpine/init
 
 init_tests \
-	set_network_config_network_interfaces
+	set_network_config_network_interfaces \
+	userdata_ntp \
+	userdata_ntp_busybox \
+	userdata_ntp_openntpd
 
 set_network_config_network_interfaces_body() {
 	fake_metadata_nocloud <<-EOF
@@ -39,3 +42,47 @@ set_network_config_network_interfaces_body() {
 		-o match:"^nameserver 8.8.4.4$" \
 		cat etc/resolv.conf
 }
+
+userdata_ntp_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		ntp:
+		  enabled: true
+	EOF
+	atf_check \
+		-e match:"userdata_ntp .*DONE" \
+		-o match:"apk add.*chrony" \
+		-o match:"rc-update .*chronyd" \
+		-o match:"rc-service .*chronyd" \
+		tiny-cloud main
+}
+
+userdata_ntp_busybox_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		ntp:
+		  enabled: true
+		  ntp_client: busybox
+	EOF
+	atf_check \
+		-e match:"userdata_ntp .*DONE" \
+		-o not-match:"apk add" \
+		-o match:"rc-update .*ntpd" \
+		-o match:"rc-service .*ntpd" \
+		tiny-cloud main
+}
+
+userdata_ntp_openntpd_body() {
+	fake_userdata_nocloud <<-EOF
+		#alpine-config
+		ntp:
+		  enabled: true
+		  ntp_client: openntpd
+	EOF
+	atf_check \
+		-e match:"userdata_ntp .*DONE" \
+		-o match:"apk add.*openntpd" \
+		-o match:"rc-update .*openntpd" \
+		-o match:"rc-service .*openntpd" \
+		tiny-cloud main
+}
-- 
2.40.1

