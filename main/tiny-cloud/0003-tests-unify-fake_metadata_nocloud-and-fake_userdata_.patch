From e1efba6238d985343dbbd941ea4ecea0c25150a2 Mon Sep 17 00:00:00 2001
From: Natanael Copa <ncopa@alpinelinux.org>
Date: Thu, 4 May 2023 12:23:07 +0200
Subject: [PATCH 3/9] tests: unify fake_metadata_nocloud and
 fake_userdata_nocloud

Avoid duplication of code.
---
 tests/test_env.sh | 23 +++++++++--------------
 1 file changed, 9 insertions(+), 14 deletions(-)

diff --git a/tests/test_env.sh b/tests/test_env.sh
index f197bb8..a040a4f 100644
--- a/tests/test_env.sh
+++ b/tests/test_env.sh
@@ -39,7 +39,8 @@ fake_umount() {
 	EOF
 }
 
-fake_userdata_nocloud() {
+fake_data_nocloud() {
+	local datafile="$1"
 	local file="$(mktemp -p "$PWD")"
 	cat > "$file"
 	fake_bin mount <<-EOF
@@ -48,24 +49,18 @@ fake_userdata_nocloud() {
 		while ! [ -d "\$1" ]; do
 			shift
 		done
-		cp "$file" "\$1"/user-data
+		cp "$file" "\$1"/$datafile
 	EOF
 	mkdir -p mnt
+	fake_umount
 }
 
 fake_metadata_nocloud() {
-	local file="$(mktemp -p "$PWD")"
-	cat > "$file"
-	fake_bin mount <<-EOF
-		#!/bin/sh
-		# find last arg which is the mount dir
-		while ! [ -d "\$1" ]; do
-			shift
-		done
-		cp "$file" "\$1"/meta-data
-	EOF
-	mkdir -p mnt
-	fake_umount
+	fake_data_nocloud meta-data
+}
+
+fake_userdata_nocloud() {
+	fake_data_nocloud user-data
 }
 
 fake_interfaces() {
-- 
2.40.1

